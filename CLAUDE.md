# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Granola Sync for Obsidian (Fork)** - A streamlined Obsidian plugin that syncs meeting notes from Granola AI to an Obsidian vault. This is a simplified fork of [dannymcc/Granola-to-Obsidian](https://github.com/dannymcc/Granola-to-Obsidian) focused on core sync functionality with configurable frontmatter.

- **Type**: Obsidian plugin (TypeScript with esbuild)
- **Language**: TypeScript
- **Current Version**: Check `manifest.json` for the current version
- **Minimum Obsidian Version**: 1.6.6

## Fork-Specific Features

This fork is streamlined for a specific workflow:

| Feature | Description |
|---------|-------------|
| People as wiki links | `[[John Smith]]` instead of tags |
| Company as wiki links | Organizations extracted from attendees as `[[Company Name]]` in `org` field |
| Meeting platform detection | Auto-detects Zoom/Google Meet/Teams and adds `[[Platform]]` to `loc` field |
| Auto-detect user | Automatically identifies your name from calendar (no manual config needed) |
| Attachment downloads | Downloads meeting screenshots/files and embeds them in notes |
| German umlaut conversion | `ae` → `ä`, `oe` → `ö`, `ue` → `ü` (smart: preserves Miguel, Michael, Joel, etc.) |
| Calendar-based dates | `date`/`dateEnd` from Google Calendar, `noteStarted`/`noteEnded` from Granola timestamps |
| Attendee filtering | Filter by calendar response status (accepted, tentative, declined) |
| Email extraction | Attendee emails in frontmatter |
| Configurable frontmatter | Custom category, tags, empty fields for manual entry |
| Daily note integration | Adds today's meetings to your daily note |
| Smart sync | Updates notes when Granola has new content while preserving frontmatter edits |
| Simplified settings | Removed rarely-used features |

**Removed from original**: Periodic note integration, Granola folders, attendee tags, folder tags, date-based folders, duplicate detection, reorganize notes, note prefix, experimental search scope.

## Architecture

### TypeScript Project Structure

```
src/
├── main.ts       # Main plugin class (GranolaSyncPlugin)
├── settings.ts   # Settings tab UI (GranolaSyncSettingTab)
├── types.ts      # TypeScript interfaces and types
├── constants.ts  # Constants and default settings
└── utils.ts      # Utility functions
```

### Source Files

| File | Purpose |
|------|---------|
| `src/main.ts` | Main plugin class with sync logic |
| `src/settings.ts` | Settings tab UI |
| `src/types.ts` | TypeScript interfaces (GranolaDocument, GranolaSyncSettings, etc.) |
| `src/constants.ts` | Constants, API config, default settings |
| `src/utils.ts` | Utility functions (formatDate, escapeYaml, convertProseMirror, etc.) |

### Build Output

| File | Purpose |
|------|---------|
| `main.js` | Bundled plugin code (generated by esbuild) |
| `manifest.json` | Plugin metadata, version |
| `styles.css` | Plugin UI styles |
| `versions.json` | Version history |

### Document Processing Flow

```
syncNotes()
  ↓
fetchGranolaDocuments(token) → [documents]
  ↓
for each document:
  → fetchTranscript() if enabled
  → processDocument()
    → downloadAttachments() [if enabled]
    → extractAttendeeNames() + generatePeopleLinks()
    → extractCompanyNames() [for org wiki links]
    → detectMeetingPlatform() [for loc: [[Zoom]]/[[Google Meet]]/[[Teams]]]
    → getEffectiveMyName() [auto-detect or manual override]
    → buildFrontmatter() [date, dateEnd, noteStarted, noteEnded, org, loc, people, etc.]
    → buildNoteContent() [My Notes, Enhanced Notes, Transcript, Attachments]
    → generateFilename() [template + date formatting]
    → create/update file (preserves frontmatter if updating)
  → track today's notes for daily note integration
  ↓
if enableDailyNoteIntegration:
  → updateDailyNote() [append to Daily/YYYY-MM-DD note]
```

### Key Integration Points

- **Granola API**: Reads auth token from `~/Library/Application Support/Granola/supabase.json` (macOS) or `~/.config/Granola/supabase.json` (Linux)
- **Obsidian**: Uses Plugin API for file management, settings, status bar, commands
- **ProseMirror**: `convertProseMirrorToMarkdown()` converts Granola's rich editor format to markdown

## Development

### Prerequisites

- Node.js 18+
- npm

### Commands

```bash
npm install          # Install dependencies
npm run dev          # Development mode with watch
npm run build        # Production build (type-check + bundle)
```

### Testing Manually

1. Run `npm run build` to generate `main.js`
2. The plugin files are symlinked to your Obsidian vault
3. Reload Obsidian or reload plugin (`Cmd+Shift+I` → reload)
4. Trigger manual sync from ribbon icon or command palette

**Debugging**: Check Obsidian console (`Cmd/Ctrl + Shift + I` → Console tab)

## Settings Reference

| Setting | Default | Description |
|---------|---------|-------------|
| `syncDirectory` | `Notes` | Where to save synced notes |
| `filenameTemplate` | `{created_date}_{title}` | Filename format |
| `dateFormat` | `YYYY-MM-DD` | Date format in filenames |
| `slashReplacement` | `&` | Replace `/` in titles (e.g., "Jane / John" → "Jane & John") |
| `autoSyncFrequency` | 5 minutes | Auto-sync interval (0 = manual) |
| `skipExistingNotes` | `true` | Don't overwrite existing notes (but update if Granola has new content) |
| `includeMyNotes` | `true` | Include personal notes section |
| `includeEnhancedNotes` | `true` | Include AI summaries |
| `includeFullTranscript` | `false` | Include meeting transcript |
| `includeGranolaUrl` | `true` | Add link back to Granola |
| `includeEmails` | `true` | Include attendee emails |
| `attendeeFilter` | `all` | Filter attendees by response status: `all`, `accepted`, `accepted_tentative`, `exclude_declined` |
| `autoDetectMyName` | `true` | Auto-detect user name from calendar attendees |
| `myName` | `''` | Manual override for user name |
| `enableLocationDetection` | `true` | Auto-detect Zoom/Google Meet/Teams for `loc` field |
| `downloadAttachments` | `true` | Download and embed meeting attachments (uses Obsidian's attachment folder setting) |
| `enableCustomFrontmatter` | `true` | Use custom frontmatter template |
| `enableDailyNoteIntegration` | `true` | Add meetings to daily note |
| `dailyNoteSectionName` | `## Granola Meetings` | Section heading in daily note |

## Common Development Tasks

### Adding a New Setting

1. Add type to `GranolaSyncSettings` interface in `src/types.ts`
2. Add default value to `DEFAULT_SETTINGS` in `src/constants.ts`
3. Add UI control in `GranolaSyncSettingTab.display()` in `src/settings.ts`
4. Use via `this.settings.yourNewSetting` in `src/main.ts`

### Modifying Frontmatter

Edit `buildFrontmatter()` method in `src/main.ts`. The frontmatter is YAML format between `---` delimiters.

### German Umlaut Conversion Logic

The `convertGermanUmlauts()` function in `src/utils.ts` converts `ae` → `ä`, `oe` → `ö`, `ue` → `ü` but uses pattern detection to preserve non-German names:
- `uel` not followed by another `l` → preserved (Miguel, Samuel, Manuela)
- `ael` anywhere → preserved (Michael, Raphael, Michaela)
- `oel` anywhere → preserved (Joel, Noel)
- Otherwise → converted (Mueller → Müller, Schroeder → Schröder)

### Adding New API Integration

1. Add types to `src/types.ts`
2. Get auth token via `loadCredentials()` in `src/main.ts`
3. Make fetch requests following the pattern in `fetchGranolaDocuments()`, `fetchTranscript()`

### Type Definitions

Key interfaces in `src/types.ts`:
- `GranolaSyncSettings` - Plugin settings
- `GranolaDocument` - API document response
- `GranolaCalendarEvent` - Google Calendar event data
- `ProseMirrorNode` - Rich text content format
- `GranolaAttachment` - Meeting attachments
