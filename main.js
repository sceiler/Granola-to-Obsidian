/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var ft=Object.create;var G=Object.defineProperty;var yt=Object.getOwnPropertyDescriptor;var St=Object.getOwnPropertyNames;var Nt=Object.getPrototypeOf,Dt=Object.prototype.hasOwnProperty;var _t=(d,i)=>{for(var e in i)G(d,e,{get:i[e],enumerable:!0})},lt=(d,i,e,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of St(i))!Dt.call(d,t)&&t!==e&&G(d,t,{get:()=>i[t],enumerable:!(n=yt(i,t))||n.enumerable});return d};var Z=(d,i,e)=>(e=d!=null?ft(Nt(d)):{},lt(i||!d||!d.__esModule?G(e,"default",{value:d,enumerable:!0}):e,d)),wt=d=>lt(G({},"__esModule",{value:!0}),d);var Ft={};_t(Ft,{default:()=>U});module.exports=wt(Ft);var T=require("obsidian"),M=Z(require("path")),V=Z(require("fs")),H=Z(require("os"));var K=require("obsidian"),L=100,O=1e3,R=1,Q="https://api.granola.ai",tt="5.354.0";function et(){return K.Platform.isWin?"AppData/Roaming/Granola/supabase.json":K.Platform.isLinux?".config/Granola/supabase.json":"Library/Application Support/Granola/supabase.json"}var B=["granola_id","noteEnded"],nt=[{key:"category",enabled:!0},{key:"type",enabled:!0},{key:"date",enabled:!0},{key:"dateEnd",enabled:!0},{key:"noteStarted",enabled:!0},{key:"noteEnded",enabled:!0},{key:"org",enabled:!0},{key:"loc",enabled:!0},{key:"people",enabled:!0},{key:"topics",enabled:!0},{key:"tags",enabled:!0},{key:"emails",enabled:!0},{key:"granola_id",enabled:!0},{key:"title",enabled:!0},{key:"granola_url",enabled:!0}],st={syncDirectory:"Notes",authKeyPath:et(),filenameTemplate:"{created_date}_{title}",dateFormat:"YYYY-MM-DD",autoSyncFrequency:3e5,skipExistingNotes:!0,existingFileAction:"timestamp",filenameSeparator:" ",slashReplacement:"&",documentSyncLimit:100,includeFullTranscript:!1,includeMyNotes:!0,includeEnhancedNotes:!0,includeGranolaUrl:!0,includeEmails:!0,attendeeFilter:"all",excludeMyNameFromPeople:!0,autoDetectMyName:!0,myName:"",enableLocationDetection:!0,downloadAttachments:!0,enableCustomFrontmatter:!0,customCategory:"[[Meetings]]",customTags:"meetings",enableDailyNoteIntegration:!0,dailyNoteSectionName:"## Granola Meetings",frontmatterFields:nt},ct=["png","jpg","jpeg","gif","webp","svg","bmp"],x={image:"png","image/png":"png","image/jpeg":"jpg","image/jpg":"jpg","image/gif":"gif","image/webp":"webp","image/svg+xml":"svg","application/pdf":"pdf"};function $(d,i="JSON"){try{return{data:JSON.parse(d),error:null}}catch(e){let n=e instanceof Error?e.message:"Unknown error";return{data:null,error:`Failed to parse ${i}: ${n}`}}}function F(d){if(d==null)return"";let i=String(d);return/[:\[\]{}#&*!|>'"%@`\n]/.test(i)||i.trim()!==i?'"'+i.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"':i}function A(d,i){if(!d)return"";let e=new Date(d),n=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),o=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),c=String(e.getSeconds()).padStart(2,"0");return i.replace(/YYYY/g,String(n)).replace(/YY/g,String(n).slice(-2)).replace(/MM/g,t).replace(/DD/g,s).replace(/HH/g,o).replace(/mm/g,a).replace(/ss/g,c)}function b(d){try{let i=new Date(d),e=i.getFullYear(),n=String(i.getMonth()+1).padStart(2,"0"),t=String(i.getDate()).padStart(2,"0"),s=String(i.getHours()).padStart(2,"0"),o=String(i.getMinutes()).padStart(2,"0");return`${e}-${n}-${t}T${s}:${o}`}catch(i){return null}}function ut(d,i){let e=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],s=["January","February","March","April","May","June","July","August","September","October","November","December"],o=d.getFullYear(),a=d.getMonth(),c=d.getDate(),l=d.getDay();return i.replace(/YYYY/g,String(o)).replace(/YY/g,String(o).slice(-2)).replace(/MMMM/g,s[a]).replace(/MMM/g,t[a]).replace(/MM/g,String(a+1).padStart(2,"0")).replace(/M(?![ao])/g,String(a+1)).replace(/dddd/g,n[l]).replace(/ddd/g,e[l]).replace(/DD/g,String(c).padStart(2,"0")).replace(/D(?![ae])/g,String(c))}function vt(d){let i=new Date(d);return[i.getHours(),i.getMinutes(),i.getSeconds()].map(e=>String(e).padStart(2,"0")).join(":")}function Et(d){switch(d){case"microphone":return"Me";case"system":default:return"Them"}}function dt(d){if(!d||d.length===0)return"*No transcript content available*";let i=d.slice().sort((a,c)=>{let l=new Date(a.start_timestamp||0),r=new Date(c.start_timestamp||0);return l.getTime()-r.getTime()}),e=[],n=null,t="",s=null,o=()=>{let a=t.trim().replace(/\s+/g," ");if(a&&n&&s){let c=vt(s),l=Et(n);e.push(`**${l}** *(${c})*: ${a}`)}t="",n=null,s=null};for(let a of i){n&&n!==a.source&&o(),n||(n=a.source,s=a.start_timestamp);let c=a.text;c&&c.trim()&&(t+=t?` ${c}`:c)}return o(),e.length===0?"*No transcript content available*":e.join(`

`)}function gt(d){if(!d)return d;let i=[/uel([^l]|$)/i,/ael/i,/oel/i];return d.split(/(\s+)/).map(n=>{if(/^\s+$/.test(n))return n;for(let t of i)if(t.test(n))return n;return n.replace(/\bAe/g,"\xC4").replace(/\bOe/g,"\xD6").replace(/\bUe/g,"\xDC").replace(/ae/g,"\xE4").replace(/oe/g,"\xF6").replace(/ue/g,"\xFC")}).join("")}function I(d){if(!d||typeof d!="object"||!d.content)return"";let i=(e,n=0)=>{var a,c;if(!e||typeof e!="object")return"";let t=e.type||"",s=e.content||[],o=e.text||"";if(t==="heading"){let l=(c=(a=e.attrs)==null?void 0:a.level)!=null?c:1,r=s.map(u=>i(u,n)).join("");return"#".repeat(l)+" "+r+`

`}else{if(t==="paragraph")return s.map(r=>i(r,n)).join("")+`

`;if(t==="bulletList"){let l=[];for(let r of s)if(r.type==="listItem"){let u=pt(r,n);u&&l.push(u)}return l.join(`
`)+`

`}else return t==="text"?o:s.map(l=>i(l,n)).join("")}};return i(d)}function pt(d,i=0){if(!d||!d.content)return"";let e="  ".repeat(i),n="",t=!1;for(let o of d.content)if(o.type==="paragraph"){let a=(o.content||[]).map(c=>c.type==="text"&&c.text||"").join("").trim();a&&(n+=a)}else if(o.type==="bulletList"){t=!0;let a=[];for(let c of o.content||[])if(c.type==="listItem"){let l=pt(c,i+1);l&&a.push(l)}a.length>0&&(n+=`
`+a.join(`
`))}if(!n.trim())return"";let s=e+"- "+n.split(`
`)[0];if(t){let o=n.split(`
`);if(o.length>1){let a=o.slice(1).join(`
`);return s+`
`+a}}return s}function mt(d,i){var n;if(i){let t=i.toLowerCase().split(";")[0].trim();if(x[t])return x[t];let s=t.match(/^image\/(\w+)/);if(s)return s[1]}if(d.type&&x[d.type])return x[d.type];let e=(n=d.url)==null?void 0:n.match(/\.(\w{3,4})(?:\?|$)/);return e?e[1]:d.type==="image"||d.width||d.height?"png":"bin"}function j(d){return d.split("@")[0].replace(/[._-]/g," ").split(" ").map(i=>i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join(" ")}var y=require("obsidian");var Tt={category:"Category",type:"Type (empty)",date:"Date",dateEnd:"Date end",noteStarted:"Note started",noteEnded:"Note ended",org:"Organization",loc:"Location",people:"People",topics:"Topics (empty)",tags:"Tags",emails:"Emails",granola_id:"Granola ID",title:"Title",granola_url:"Granola URL"},Y=class extends y.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;if(i.empty(),i.createEl("h3",{text:"Sync settings"}),new y.Setting(i).setName("Sync directory").setDesc("Directory where Granola notes will be synced").addText(t=>{t.setPlaceholder("Notes"),t.setValue(this.plugin.settings.syncDirectory),t.onChange(async s=>{this.plugin.settings.syncDirectory=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Auth key path").setDesc("Path to your Granola authentication key file (relative to home directory)").addText(t=>{t.setPlaceholder(et()),t.setValue(this.plugin.settings.authKeyPath),t.onChange(async s=>{this.plugin.settings.authKeyPath=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Auto-sync frequency").setDesc("How often to automatically sync notes").addDropdown(t=>{t.addOption("0","Never (manual only)"),t.addOption("60000","Every 1 minute"),t.addOption("300000","Every 5 minutes"),t.addOption("600000","Every 10 minutes"),t.addOption("1800000","Every 30 minutes"),t.addOption("3600000","Every 1 hour"),t.addOption("86400000","Every 24 hours"),t.setValue(String(this.plugin.settings.autoSyncFrequency)),t.onChange(async s=>{this.plugin.settings.autoSyncFrequency=parseInt(s),await this.plugin.saveSettings()})}),new y.Setting(i).setName("Document limit").setDesc(`Maximum number of documents to sync (${R}-${O})`).addText(t=>{t.setPlaceholder("100"),t.setValue(String(this.plugin.settings.documentSyncLimit)),t.onChange(async s=>{let o=parseInt(s);if(!isNaN(o)&&o>=R&&o<=O)this.plugin.settings.documentSyncLimit=o,await this.plugin.saveSettings();else if(!isNaN(o)){let a=Math.max(R,Math.min(O,o));this.plugin.settings.documentSyncLimit=a,t.setValue(String(a)),await this.plugin.saveSettings()}})}),new y.Setting(i).setName("Skip existing notes").setDesc("Don't update notes that already exist (preserves manual edits)").addToggle(t=>{t.setValue(this.plugin.settings.skipExistingNotes),t.onChange(async s=>{this.plugin.settings.skipExistingNotes=s,await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Filename settings"}),new y.Setting(i).setName("Filename template").setDesc("Use {title}, {created_date}, {updated_date}, {id}, etc.").addText(t=>{t.setPlaceholder("{created_date}_{title}"),t.setValue(this.plugin.settings.filenameTemplate),t.onChange(async s=>{this.plugin.settings.filenameTemplate=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Date format").setDesc("Format for dates. Use YYYY, MM, DD").addText(t=>{t.setPlaceholder("YYYY-MM-DD"),t.setValue(this.plugin.settings.dateFormat),t.onChange(async s=>{this.plugin.settings.dateFormat=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Word separator").setDesc("Character to separate words in filenames").addDropdown(t=>{t.addOption("_","Underscore (_)"),t.addOption("-","Hyphen (-)"),t.addOption(" ","Space"),t.addOption("","None"),t.setValue(this.plugin.settings.filenameSeparator),t.onChange(async s=>{this.plugin.settings.filenameSeparator=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Slash replacement").setDesc('Replace "/" in titles (e.g., "Jane / John" \u2192 "Jane & John")').addDropdown(t=>{t.addOption("&","Ampersand (&)"),t.addOption("-","Hyphen (-)"),t.addOption("+","Plus (+)"),t.addOption("~","Tilde (~)"),t.addOption("x","x"),t.addOption("","Remove"),t.setValue(this.plugin.settings.slashReplacement),t.onChange(async s=>{this.plugin.settings.slashReplacement=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("When filename exists").setDesc("What to do when a file with the same name exists").addDropdown(t=>{t.addOption("timestamp","Add timestamp"),t.addOption("skip","Skip"),t.setValue(this.plugin.settings.existingFileAction),t.onChange(async s=>{this.plugin.settings.existingFileAction=s,await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Note content"}),new y.Setting(i).setName("Include My Notes").setDesc("Include your personal notes from Granola").addToggle(t=>{t.setValue(this.plugin.settings.includeMyNotes),t.onChange(async s=>{this.plugin.settings.includeMyNotes=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Include Enhanced Notes").setDesc("Include AI-generated enhanced notes").addToggle(t=>{t.setValue(this.plugin.settings.includeEnhancedNotes),t.onChange(async s=>{this.plugin.settings.includeEnhancedNotes=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Include transcript").setDesc("Include full meeting transcript (slower sync)").addToggle(t=>{t.setValue(this.plugin.settings.includeFullTranscript),t.onChange(async s=>{this.plugin.settings.includeFullTranscript=s,await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Frontmatter"}),new y.Setting(i).setName("Include Granola URL").setDesc("Add link back to original Granola note").addToggle(t=>{t.setValue(this.plugin.settings.includeGranolaUrl),t.onChange(async s=>{this.plugin.settings.includeGranolaUrl=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Include emails").setDesc("Include attendee email addresses").addToggle(t=>{t.setValue(this.plugin.settings.includeEmails),t.onChange(async s=>{this.plugin.settings.includeEmails=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Attendee filter").setDesc("Filter attendees based on their calendar response status").addDropdown(t=>{t.addOption("all","Include everyone"),t.addOption("accepted","Only accepted"),t.addOption("accepted_tentative","Accepted + tentative"),t.addOption("exclude_declined","Exclude declined"),t.setValue(this.plugin.settings.attendeeFilter),t.onChange(async s=>{this.plugin.settings.attendeeFilter=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Exclude my name from people").setDesc("Filter out your name from the people list").addToggle(t=>{t.setValue(this.plugin.settings.excludeMyNameFromPeople),t.onChange(async s=>{this.plugin.settings.excludeMyNameFromPeople=s,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.excludeMyNameFromPeople&&(new y.Setting(i).setName("Auto-detect my name").setDesc('Automatically detect your name from calendar attendees (uses the attendee marked as "self")').addToggle(t=>{t.setValue(this.plugin.settings.autoDetectMyName),t.onChange(async s=>{this.plugin.settings.autoDetectMyName=s,await this.plugin.saveSettings(),this.display()})}),new y.Setting(i).setName("My name (override)").setDesc(this.plugin.settings.autoDetectMyName?"Leave empty to use auto-detected name, or enter a name to override":"Your name as it appears in Granola meetings").addText(t=>{t.setPlaceholder(this.plugin.settings.autoDetectMyName?"Auto-detected":"John Doe"),t.setValue(this.plugin.settings.myName),t.onChange(async s=>{this.plugin.settings.myName=s,await this.plugin.saveSettings()})})),new y.Setting(i).setName("Detect meeting platform").setDesc("Automatically detect Zoom, Google Meet, or Teams from calendar and add as wiki link to loc field").addToggle(t=>{t.setValue(this.plugin.settings.enableLocationDetection),t.onChange(async s=>{this.plugin.settings.enableLocationDetection=s,await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Attachments"}),new y.Setting(i).setName("Download attachments").setDesc("Download meeting attachments (screenshots, etc.) and embed them in the note").addToggle(t=>{t.setValue(this.plugin.settings.downloadAttachments),t.onChange(async s=>{this.plugin.settings.downloadAttachments=s,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.downloadAttachments){let t=this.app.vault.getConfig("attachmentFolderPath")||"Vault root",s=i.createEl("p",{text:"Attachments will be saved to: "+t,cls:"setting-item-description"});s.style.marginTop="-10px";let o=i.createEl("p",{text:"Configure attachment location in Obsidian Settings \u2192 Files & Links \u2192 Default location for new attachments",cls:"setting-item-description"});o.style.fontSize="0.85em"}i.createEl("h3",{text:"Custom frontmatter template"}),new y.Setting(i).setName("Enable custom frontmatter").setDesc("Add custom fields like category, type, org, loc, topics").addToggle(t=>{t.setValue(this.plugin.settings.enableCustomFrontmatter),t.onChange(async s=>{this.plugin.settings.enableCustomFrontmatter=s,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.enableCustomFrontmatter&&(new y.Setting(i).setName("Category").setDesc("Default category value (e.g., [[Meetings]])").addText(t=>{t.setPlaceholder("[[Meetings]]"),t.setValue(this.plugin.settings.customCategory),t.onChange(async s=>{this.plugin.settings.customCategory=s,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Tags").setDesc("Default tags (comma-separated)").addText(t=>{t.setPlaceholder("meetings"),t.setValue(this.plugin.settings.customTags),t.onChange(async s=>{this.plugin.settings.customTags=s,await this.plugin.saveSettings()})})),i.createEl("h3",{text:"Frontmatter field order"});let e=i.createEl("p",{text:"Enable/disable fields and reorder them. Required fields cannot be disabled.",cls:"setting-item-description"});e.style.marginBottom="10px";let n=i.createDiv({cls:"granola-field-order-list"});for(let t=0;t<this.plugin.settings.frontmatterFields.length;t++){let s=this.plugin.settings.frontmatterFields[t],o=B.includes(s.key),a=t===0,c=t===this.plugin.settings.frontmatterFields.length-1,l=new y.Setting(n).setName(Tt[s.key]||s.key).setDesc(o?"Required":"");l.addToggle(r=>{r.setValue(s.enabled),r.setDisabled(o),r.onChange(async u=>{this.plugin.settings.frontmatterFields[t].enabled=u,await this.plugin.saveSettings()})}),l.addButton(r=>{r.setIcon("arrow-up"),r.setTooltip("Move up"),r.setDisabled(a),r.onClick(async()=>{if(t>0){let u=this.plugin.settings.frontmatterFields[t-1];this.plugin.settings.frontmatterFields[t-1]=this.plugin.settings.frontmatterFields[t],this.plugin.settings.frontmatterFields[t]=u,await this.plugin.saveSettings(),this.display()}})}),l.addButton(r=>{r.setIcon("arrow-down"),r.setTooltip("Move down"),r.setDisabled(c),r.onClick(async()=>{if(t<this.plugin.settings.frontmatterFields.length-1){let u=this.plugin.settings.frontmatterFields[t+1];this.plugin.settings.frontmatterFields[t+1]=this.plugin.settings.frontmatterFields[t],this.plugin.settings.frontmatterFields[t]=u,await this.plugin.saveSettings(),this.display()}})})}i.createEl("h3",{text:"Daily note integration"}),new y.Setting(i).setName("Enable daily note integration").setDesc("Add today's meetings to your daily note").addToggle(t=>{t.setValue(this.plugin.settings.enableDailyNoteIntegration),t.onChange(async s=>{this.plugin.settings.enableDailyNoteIntegration=s,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.enableDailyNoteIntegration&&new y.Setting(i).setName("Section heading").setDesc("Heading for the Granola meetings section in your daily note").addText(t=>{t.setPlaceholder("## Granola Meetings"),t.setValue(this.plugin.settings.dailyNoteSectionName),t.onChange(async s=>{this.plugin.settings.dailyNoteSectionName=s,await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Actions"}),new y.Setting(i).setName("Sync now").setDesc("Manually sync your Granola notes").addButton(t=>{t.setButtonText("Sync now"),t.setCta(),t.onClick(async()=>{await this.plugin.syncNotes()})})}};var U=class extends T.Plugin{constructor(){super(...arguments);this.settings=st;this.autoSyncInterval=null;this.statusBarItem=null;this.ribbonIconEl=null}async onload(){await this.loadSettings(),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar("Idle"),this.ribbonIconEl=this.addRibbonIcon("sync","Sync Granola notes",()=>{this.syncNotes()}),this.addCommand({id:"sync-granola-notes",name:"Sync Granola Notes",callback:()=>{this.syncNotes()}}),this.addSettingTab(new Y(this.app,this)),window.setTimeout(()=>{this.setupAutoSync()},1e3)}onunload(){this.clearAutoSync(),this.statusBarItem&&(this.statusBarItem.remove(),this.statusBarItem=null),this.ribbonIconEl&&(this.ribbonIconEl.remove(),this.ribbonIconEl=null)}async loadSettings(){let e=await this.loadData();this.settings=Object.assign({},st,e),(!this.settings.frontmatterFields||this.settings.frontmatterFields.length===0)&&(this.settings.frontmatterFields=nt.map(n=>({...n})))}async saveSettings(){await this.saveData(this.settings),this.setupAutoSync()}updateStatusBar(e,n){if(!this.statusBarItem)return;let t="Granola: ";e==="Idle"?t+="Idle":e==="Syncing"?t+=typeof n=="string"?n:"Syncing...":e==="Complete"?(t+=n+" synced",window.setTimeout(()=>this.updateStatusBar("Idle"),3e3)):e==="Error"&&(t+="Error - "+(n||"sync failed"),window.setTimeout(()=>this.updateStatusBar("Idle"),5e3)),this.statusBarItem.setText(t)}setupAutoSync(){this.clearAutoSync(),this.settings.autoSyncFrequency>0&&(this.autoSyncInterval=window.setInterval(()=>{this.syncNotes().catch(e=>{console.error("Auto-sync failed:",e),this.updateStatusBar("Error","auto-sync failed")})},this.settings.autoSyncFrequency))}clearAutoSync(){this.autoSyncInterval&&(window.clearInterval(this.autoSyncInterval),this.autoSyncInterval=null)}async syncNotes(){try{this.updateStatusBar("Syncing"),await this.ensureDirectoryExists();let e=await this.loadCredentials();if(!e){this.updateStatusBar("Error","credentials failed");return}let n=await this.fetchGranolaDocuments(e);if(!n){this.updateStatusBar("Error","fetch failed");return}let t=0,s=[],o=new Date().toDateString();for(let a of n)try{if(this.settings.includeFullTranscript){let l=await this.fetchTranscript(e,a.id);a.transcript=dt(l)}if(await this.processDocument(a,e)&&t++,this.settings.enableDailyNoteIntegration&&a.created_at&&new Date(a.created_at).toDateString()===o){let r=await this.findExistingNoteByGranolaId(a.id);if(r){let u=new Date(a.created_at),p=String(u.getHours()).padStart(2,"0"),m=String(u.getMinutes()).padStart(2,"0");s.push({title:a.title||"Untitled Granola Note",actualFilePath:r.path,time:p+":"+m})}}}catch(c){console.error("Error processing document "+a.title+":",c)}this.settings.enableDailyNoteIntegration&&s.length>0&&await this.updateDailyNote(s),this.updateStatusBar("Complete",t)}catch(e){console.error("Granola sync failed:",e),this.updateStatusBar("Error","sync failed")}}async loadCredentials(){let e=H.homedir(),n=H.userInfo().username,t=[M.resolve(e,"Users",n,"Library/Application Support/Granola/supabase.json"),M.resolve(e,this.settings.authKeyPath),M.resolve(e,"Library/Application Support/Granola/supabase.json")];for(let s of t)try{if(!V.existsSync(s))continue;let o;try{o=V.readFileSync(s,"utf8")}catch(r){console.error("Failed to read credentials file:",r);continue}let{data:a,error:c}=$(o,"Granola credentials file");if(c||!a){console.error(c);continue}let l=null;if(a.workos_tokens)if(typeof a.workos_tokens=="string"){let{data:r}=$(a.workos_tokens,"WorkOS tokens");r&&(l=r.access_token)}else typeof a.workos_tokens=="object"&&(l=a.workos_tokens.access_token);if(!l&&a.cognito_tokens)if(typeof a.cognito_tokens=="string"){let{data:r}=$(a.cognito_tokens,"Cognito tokens");r&&(l=r.access_token)}else typeof a.cognito_tokens=="object"&&(l=a.cognito_tokens.access_token);if(l)return l}catch(o){console.error("Error loading credentials:",o);continue}return console.error("No valid Granola credentials found. Please ensure Granola is installed and you are logged in."),null}async fetchGranolaDocuments(e){try{let n=[],t=0,s=!0,o=this.settings.documentSyncLimit;for(;s&&n.length<o;){let c=(await(0,T.requestUrl)({url:`${Q}/v2/get-documents`,method:"POST",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json",Accept:"*/*","User-Agent":`Granola/${tt}`,"X-Client-Version":tt},body:JSON.stringify({limit:L,offset:t,include_last_viewed_panel:!0,include_panels:!0})})).json;if(!c||!c.docs)return n.length>0?n:null;let l=c.docs;n.push(...l),l.length<L||n.length>=o?s=!1:t+=L,n.length>100&&this.updateStatusBar("Syncing",`${n.length} docs fetched`)}return n.length>o&&(n.length=o),n}catch(n){return console.error("Error fetching documents:",n),null}}async fetchTranscript(e,n){try{return(await(0,T.requestUrl)({url:`${Q}/v1/get-document-transcript`,method:"POST",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({document_id:n})})).json}catch(t){return console.error("Error fetching transcript for document "+n+":",t),null}}extractPanelContent(e,n){if(e.panels&&Array.isArray(e.panels)){for(let t of e.panels)if(t.type===n&&t.content&&t.content.type==="doc")return t.content}return n==="my_notes"&&e.notes&&e.notes.type==="doc"?e.notes:n==="enhanced_notes"&&e.last_viewed_panel&&e.last_viewed_panel.content&&e.last_viewed_panel.content.type==="doc"?e.last_viewed_panel.content:null}buildResponseStatusMap(e){var t;let n=new Map;if((t=e.google_calendar_event)!=null&&t.attendees)for(let s of e.google_calendar_event.attendees)s.email&&s.responseStatus&&n.set(s.email.toLowerCase(),s.responseStatus);return n}shouldIncludeAttendee(e){let n=this.settings.attendeeFilter;if(n==="all"||!e)return!0;switch(n){case"accepted":return e==="accepted";case"accepted_tentative":return e==="accepted"||e==="tentative";case"exclude_declined":return e!=="declined";default:return!0}}extractCompanyNames(e){var s,o,a,c,l,r,u;let n=new Set,t=this.buildResponseStatusMap(e);try{let p=e.people;if(p&&"attendees"in p&&Array.isArray(p.attendees))for(let m of p.attendees){let S=(o=(s=m.email)==null?void 0:s.toLowerCase())!=null?o:null,f=S&&(a=t.get(S))!=null?a:null;if(this.shouldIncludeAttendee(f)&&(l=(c=m.details)==null?void 0:c.company)!=null&&l.name){let D=m.details.company.name.trim();D&&n.add(D)}}if(p&&"creator"in p&&p.creator){let m=p.creator;if((u=(r=m.details)==null?void 0:r.company)!=null&&u.name){let S=m.details.company.name.trim();S&&n.add(S)}}}catch(p){console.error("Error extracting company names:",p)}return Array.from(n)}detectMeetingPlatform(e){var n;if(!this.settings.enableLocationDetection)return"";try{let t=e.google_calendar_event;if(!t)return"";let s=(t.location||"").toLowerCase(),o=[];(n=t.conferenceData)!=null&&n.entryPoints&&(o=t.conferenceData.entryPoints.filter(c=>c.uri).map(c=>c.uri.toLowerCase()));let a=[s,...o].join(" ");return a.includes("zoom.us")||a.includes("zoom.com")?"[[Zoom]]":a.includes("meet.google.com")||a.includes("hangouts.google.com")?"[[Google Meet]]":a.includes("teams.microsoft.com")||a.includes("teams.live.com")?"[[Teams]]":""}catch(t){return console.error("Error detecting meeting platform:",t),""}}getMyNameFromDocument(e){var n,t,s,o,a,c,l,r,u,p;try{if((n=e.google_calendar_event)!=null&&n.attendees){for(let m of e.google_calendar_event.attendees)if(m.self===!0){let S=(t=m.email)==null?void 0:t.toLowerCase(),f=e.people;if(f&&"creator"in f&&f.creator&&((s=f.creator.email)==null?void 0:s.toLowerCase())===S){if((c=(a=(o=f.creator.details)==null?void 0:o.person)==null?void 0:a.name)!=null&&c.fullName)return f.creator.details.person.name.fullName;if(f.creator.name)return f.creator.name}if(f&&"attendees"in f&&Array.isArray(f.attendees)){for(let D of f.attendees)if(((l=D.email)==null?void 0:l.toLowerCase())===S&&(p=(u=(r=D.details)==null?void 0:r.person)==null?void 0:u.name)!=null&&p.fullName)return D.details.person.name.fullName}if(m.displayName)return m.displayName;if(S)return j(S)}}return null}catch(m){return console.error("Error auto-detecting user name:",m),null}}getEffectiveMyName(e){if(this.settings.myName&&this.settings.myName.trim())return this.settings.myName.trim();if(this.settings.autoDetectMyName){let n=this.getMyNameFromDocument(e);if(n)return n}return""}extractAttendeeNames(e){var o,a,c,l,r,u,p,m,S,f,D,_;let n=[],t=new Set,s=this.buildResponseStatusMap(e);try{let h=e.people;if(Array.isArray(h))for(let g of h){let N=(a=(o=g.email)==null?void 0:o.toLowerCase())!=null?a:null,C=N&&(c=s.get(N))!=null?c:null;if(!this.shouldIncludeAttendee(C)){N&&t.add(N);continue}let w=null;if((r=(l=g.details)==null?void 0:l.person)!=null&&r.name){let v=g.details.person.name;v.fullName?w=v.fullName:v.givenName&&v.familyName?w=`${v.givenName} ${v.familyName}`:v.givenName&&(w=v.givenName)}else g.display_name?w=g.display_name:g.name&&(w=g.name);w&&!n.includes(w)&&(n.push(w),N&&t.add(N))}if((u=e.google_calendar_event)!=null&&u.attendees){for(let g of e.google_calendar_event.attendees)if(!(g.email&&t.has(g.email.toLowerCase()))){if(!this.shouldIncludeAttendee((p=g.responseStatus)!=null?p:null)){g.email&&t.add(g.email.toLowerCase());continue}g.displayName&&!n.includes(g.displayName)&&(n.push(g.displayName),g.email&&t.add(g.email.toLowerCase()))}}if(Array.isArray(h)){for(let g of h)if(g.email&&!t.has(g.email.toLowerCase())){let N=(m=s.get(g.email.toLowerCase()))!=null?m:null;if(!this.shouldIncludeAttendee(N)){t.add(g.email.toLowerCase());continue}if(!(g.name||g.display_name||((f=(S=g.details)==null?void 0:S.person)==null?void 0:f.name))){let w=j(g.email);n.includes(w)||(n.push(w),t.add(g.email.toLowerCase()))}}}if((D=e.google_calendar_event)!=null&&D.attendees){for(let g of e.google_calendar_event.attendees)if(g.email&&!t.has(g.email.toLowerCase())){if(!this.shouldIncludeAttendee((_=g.responseStatus)!=null?_:null)){t.add(g.email.toLowerCase());continue}if(!g.displayName){let N=j(g.email);n.includes(N)||(n.push(N),t.add(g.email.toLowerCase()))}}}return n}catch(h){return console.error("Error extracting attendee names:",h),[]}}extractAttendeeEmails(e){var o,a,c;let n=[],t=new Set,s=this.buildResponseStatusMap(e);try{let l=e.people;if(Array.isArray(l)){for(let r of l)if(r.email&&!t.has(r.email)){let u=(o=s.get(r.email.toLowerCase()))!=null?o:null;if(!this.shouldIncludeAttendee(u)){t.add(r.email);continue}n.push(r.email),t.add(r.email)}}if((a=e.google_calendar_event)!=null&&a.attendees){for(let r of e.google_calendar_event.attendees)if(r.email&&!t.has(r.email)){if(!this.shouldIncludeAttendee((c=r.responseStatus)!=null?c:null)){t.add(r.email);continue}n.push(r.email),t.add(r.email)}}}catch(l){console.error("Error extracting attendee emails:",l)}return n}generatePeopleLinks(e,n){if(!e||e.length===0)return[];let t=[],s=this.getEffectiveMyName(n);for(let o of e){if(o=gt(o),this.settings.excludeMyNameFromPeople&&s){let c=s.toLowerCase().trim(),l=o.toLowerCase().trim();if(l===c||l.includes(c)||c.includes(l))continue;let r=c.split(/[\s\-_]+/).filter(m=>m.length>1),u=l.split(/[\s\-_]+/).filter(m=>m.length>1),p=r.filter(m=>u.some(S=>S.includes(m)||m.includes(S)));if(p.length>=Math.min(r.length,u.length)&&p.length>=2)continue}let a=`[[${o}]]`;t.includes(a)||t.push(a)}return t}getAttachmentFolder(e){let n=this.app.vault.getConfig("attachmentFolderPath")||"";if(!n||n==="/")return"";if(n==="./")return e;if(n.startsWith("./")){let t=n.slice(2);return e?M.join(e,t):t}else return n}async downloadAttachments(e,n,t){var c,l;if(!this.settings.downloadAttachments)return[];let s=e.attachments;if(!s||!Array.isArray(s)||s.length===0)return[];let o=[],a=this.getAttachmentFolder(t);try{a&&(this.app.vault.getFolderByPath(a)||await this.app.vault.createFolder(a));for(let r=0;r<s.length;r++){let u=s[r];try{let p=u.url||u.file_url||u.download_url;if(!p){console.warn("Attachment has no URL:",u);continue}let m=p.includes("cloudfront.net")||p.includes("cdn."),S={url:p,method:"GET"};m||(S.headers={Authorization:"Bearer "+n});let f=await(0,T.requestUrl)(S);if(f.arrayBuffer){let D=((c=f.headers)==null?void 0:c["content-type"])||((l=f.headers)==null?void 0:l["Content-Type"]),_=mt(u,D),h=u.filename||u.name;h||(h=`attachment_${r+1}`),h=h.replace(/\.\w{3,4}$/,"");let g=e.created_at?A(e.created_at,"YYYY-MM-DD_HH-mm"):"",N=g?`${g}_${h}.${_}`:`${h}.${_}`,C=a?M.join(a,N):N;this.app.vault.getAbstractFileByPath(C)||await this.app.vault.createBinary(C,f.arrayBuffer),o.push(N)}else console.warn("No data received for attachment:",p)}catch(p){console.error("Error downloading attachment:",u.url,p)}}}catch(r){console.error("Error processing attachments:",r)}return o}generateFilename(e){let n=e.title||"Untitled Granola Note",t=e.id||"unknown_id",s="",o="",a="",c="",l="",r="";e.created_at&&(s=A(e.created_at,this.settings.dateFormat),a=A(e.created_at,"HH-mm-ss"),l=A(e.created_at,this.settings.dateFormat+"_HH-mm-ss")),e.updated_at&&(o=A(e.updated_at,this.settings.dateFormat),c=A(e.updated_at,"HH-mm-ss"),r=A(e.updated_at,this.settings.dateFormat+"_HH-mm-ss"));let u=this.settings.filenameTemplate.replace(/{title}/g,n).replace(/{id}/g,t).replace(/{created_date}/g,s).replace(/{updated_date}/g,o).replace(/{created_time}/g,a).replace(/{updated_time}/g,c).replace(/{created_datetime}/g,l).replace(/{updated_datetime}/g,r);this.settings.slashReplacement?u=u.replace(/\s*\/\s*/g,` ${this.settings.slashReplacement} `):u=u.replace(/\s*\/\s*/g," ");let p=/[:\\|?*"]/g;return u=u.replace(p,""),u=u.replace(/\s+/g,this.settings.filenameSeparator),u}buildNoteContent(e,n,t=[]){let s=[],o=e.title||"Untitled Granola Note";s.push("# "+o);let a=this.extractPanelContent(e,"my_notes");if(a&&this.settings.includeMyNotes){let l=I(a);l&&l.trim()&&s.push(`
## My Notes

`+l.trim())}let c=this.extractPanelContent(e,"enhanced_notes");if(c&&this.settings.includeEnhancedNotes){let l=I(c);l&&l.trim()&&(a&&this.settings.includeMyNotes?s.push(`
## Enhanced Notes

`+l.trim()):s.push(`
`+l.trim()))}if(this.settings.includeFullTranscript&&n&&n!=="no_transcript"&&s.push(`
## Transcript

`+n),t.length>0){let l=t.map(r=>{var p;let u=((p=r.split(".").pop())==null?void 0:p.toLowerCase())||"";return ct.includes(u)?"![["+r+"]]":"[["+r+"]]"});s.push(`
## Attachments

`+l.join(`
`))}return s.join(`
`)}isFieldEnabled(e){let n=this.settings.frontmatterFields.find(t=>t.key===e);return n?B.includes(e)?!0:n.enabled:!1}buildFrontmatter(e,n=[]){var D,_;let t=e.title||"Untitled Granola Note",s=e.id||"unknown_id",o=this.extractAttendeeNames(e),a=this.generatePeopleLinks(o,e),c=this.extractAttendeeEmails(e),l=this.extractCompanyNames(e),r=this.detectMeetingPlatform(e),u=e.google_calendar_event,p=(D=u==null?void 0:u.start)==null?void 0:D.dateTime,m=(_=u==null?void 0:u.end)==null?void 0:_.dateTime,S={category:()=>this.settings.customCategory?`category:
  - `+F(this.settings.customCategory)+`
`:null,type:()=>`type:
`,date:()=>p?"date: "+b(p)+`
`:e.created_at?"date: "+b(e.created_at)+`
`:`date:
`,dateEnd:()=>m?"dateEnd: "+b(m)+`
`:`dateEnd:
`,noteStarted:()=>e.created_at?"noteStarted: "+b(e.created_at)+`
`:`noteStarted:
`,noteEnded:()=>e.updated_at?"noteEnded: "+b(e.updated_at)+`
`:`noteEnded:
`,org:()=>{let h=`org:
`;if(l.length>0)for(let g of l)h+="  - "+F("[["+g+"]]")+`
`;return h},loc:()=>r?`loc:
  - `+F(r)+`
`:`loc:
`,people:()=>{let h=`people:
`;if(a.length>0)for(let g of a)h+="  - "+F(g)+`
`;return h},topics:()=>`topics:
`,tags:()=>{if(!this.settings.customTags)return null;let h=`tags:
`,g=this.settings.customTags.split(",").map(N=>N.trim()).filter(N=>N);for(let N of g)h+="  - "+F(N)+`
`;return h},emails:()=>{if(!this.settings.includeEmails||c.length===0)return null;let h=`emails:
`;for(let g of c)h+="  - "+F(g)+`
`;return h},granola_id:()=>"granola_id: "+F(s)+`
`,title:()=>"title: "+F(t)+`
`,granola_url:()=>this.settings.includeGranolaUrl?"granola_url: https://notes.granola.ai/d/"+s+`
`:null},f=`---
`;for(let h of this.settings.frontmatterFields){if(!this.isFieldEnabled(h.key))continue;let g=S[h.key];if(g){let N=g();N!==null&&(f+=N)}}return f+=`---
`,f}async findExistingNoteByGranolaId(e){var s;let n=this.app.vault.getFolderByPath(this.settings.syncDirectory);if(!n)return null;let t=n.children.filter(o=>o instanceof T.TFile&&o.extension==="md");for(let o of t)try{let a=this.app.metadataCache.getFileCache(o);if((s=a==null?void 0:a.frontmatter)!=null&&s.granola_id&&String(a.frontmatter.granola_id).trim()===e)return o}catch(a){console.error("Error checking file for Granola ID:",o.path,a)}return null}async processDocument(e,n){var t,s;try{let o=e.title||"Untitled Granola Note",a=e.id||"unknown_id",c=e.transcript||"no_transcript",l=this.extractPanelContent(e,"my_notes"),r=this.extractPanelContent(e,"enhanced_notes"),u=l?I(l).trim():"",p=r?I(r).trim():"",m=!!u&&this.settings.includeMyNotes,S=!!p&&this.settings.includeEnhancedNotes,f=this.settings.includeFullTranscript&&c&&c!=="no_transcript",D=this.settings.downloadAttachments&&e.attachments&&e.attachments.length>0;if(!m&&!S&&!f&&!D)return!1;let _=await this.downloadAttachments(e,n,this.settings.syncDirectory),h=await this.findExistingNoteByGranolaId(a);if(h){if(this.settings.skipExistingNotes){let P=this.app.metadataCache.getFileCache(h),it=(t=P==null?void 0:P.frontmatter)==null?void 0:t.noteEnded,z=b(e.updated_at);if(it&&z&&z>it){let rt=this.buildNoteContent(e,c,_);await this.app.vault.process(h,ht=>{let ot=ht.match(/^---\n([\s\S]*?)\n---\n/);if(ot){let X=ot[1];return X=X.replace(/^noteEnded:.*$/m,"noteEnded: "+z),`---
`+X+`
---
`+rt}return this.buildFrontmatter(e,_)+rt})}return!0}let E=this.buildFrontmatter(e,_),q=this.buildNoteContent(e,c,_),W=E+q;return await this.app.vault.process(h,()=>W),!0}let g=this.buildFrontmatter(e,_),N=this.buildNoteContent(e,c,_),C=g+N,w=this.generateFilename(e)+".md",v=this.settings.syncDirectory,at=M.join(v,w),J=at,k=this.app.vault.getAbstractFileByPath(at);if(k&&k instanceof T.TFile){try{let E=this.app.metadataCache.getFileCache(k);if((s=E==null?void 0:E.frontmatter)!=null&&s.granola_id&&String(E.frontmatter.granola_id).trim()===a)return await this.app.vault.modify(k,C),!0}catch(E){console.error("Error checking existing file:",E)}if(this.settings.existingFileAction==="skip")return!1;if(this.settings.existingFileAction==="timestamp"){let E=A(e.created_at,"HH-mm"),W=this.generateFilename(e)+"_"+E+".md";if(J=M.join(v,W),this.app.vault.getAbstractFileByPath(J))return!1}}return await this.app.vault.create(J,C),!0}catch(o){return console.error("Error processing document:",o),!1}}async ensureDirectoryExists(){try{this.app.vault.getFolderByPath(this.settings.syncDirectory)||await this.app.vault.createFolder(this.settings.syncDirectory)}catch(e){console.error("Error creating directory:",e)}}async updateDailyNote(e){try{let n=await this.getDailyNote();if(!n)return;let t=await this.app.vault.read(n),s=this.settings.dailyNoteSectionName,o=e.sort((u,p)=>u.time.localeCompare(p.time)).map(u=>"- "+u.time+" [["+u.actualFilePath+"|"+u.title+"]]").join(`
`),a=s+`
`+o,c=this.app.metadataCache.getFileCache(n),l=(c==null?void 0:c.headings)||[],r=l.find(u=>u.heading.trim()===s.replace(/^#+\s*/,"").trim());if(r){let u=t.split(`
`),p=r.position.start.line,m=u.length;for(let D of l)if(D.position.start.line>p&&D.level<=r.level){m=D.position.start.line;break}let S=u.slice(0,p).join(`
`),f=u.slice(m).join(`
`);t=S+`
`+a+`
`+f}else t+=`

`+a;await this.app.vault.process(n,()=>t)}catch(n){console.error("Error updating daily note:",n)}}async getDailyNote(){var e;try{let n=new Date,t=this.app.internalPlugins.getPluginById("daily-notes");if(t!=null&&t.enabled){let r=((e=t.instance)==null?void 0:e.options)||{},u=r.format||"YYYY-MM-DD",p=r.folder||"",m=ut(n,u),S=p?`${p}/${m}.md`:`${m}.md`,f=this.app.vault.getAbstractFileByPath(S);if(f instanceof T.TFile)return f;let _=this.app.vault.getMarkdownFiles().find(h=>h.basename===m);if(_)return _}let s=n.getFullYear(),o=String(n.getMonth()+1).padStart(2,"0"),a=String(n.getDate()).padStart(2,"0"),c=[`${s}-${o}-${a}`,`${a}-${o}-${s}`,`${o}-${a}-${s}`],l=this.app.vault.getMarkdownFiles();for(let r of l)if(r.path.includes("Daily")){for(let u of c)if(r.path.includes(u))return r}return null}catch(n){return console.error("Error getting daily note:",n),null}}};
