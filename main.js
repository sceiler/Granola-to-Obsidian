/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var yt=Object.create;var L=Object.defineProperty;var St=Object.getOwnPropertyDescriptor;var Nt=Object.getOwnPropertyNames;var Dt=Object.getPrototypeOf,wt=Object.prototype.hasOwnProperty;var _t=(d,i)=>{for(var e in i)L(d,e,{get:i[e],enumerable:!0})},lt=(d,i,e,s)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of Nt(i))!wt.call(d,t)&&t!==e&&L(d,t,{get:()=>i[t],enumerable:!(s=St(i,t))||s.enumerable});return d};var Z=(d,i,e)=>(e=d!=null?yt(Dt(d)):{},lt(i||!d||!d.__esModule?L(e,"default",{value:d,enumerable:!0}):e,d)),vt=d=>lt(L({},"__esModule",{value:!0}),d);var Ct={};_t(Ct,{default:()=>Y});module.exports=vt(Ct);var T=require("obsidian"),C=Z(require("path")),V=Z(require("fs")),H=Z(require("os"));var K=require("obsidian"),G=100,O=1e3,B=1,Q="https://api.granola.ai",tt="5.354.0";function et(){return K.Platform.isWin?"AppData/Roaming/Granola/supabase.json":K.Platform.isLinux?".config/Granola/supabase.json":"Library/Application Support/Granola/supabase.json"}var R=["granola_id","noteEnded"],nt=[{key:"category",enabled:!0},{key:"type",enabled:!0},{key:"date",enabled:!0},{key:"dateEnd",enabled:!0},{key:"noteStarted",enabled:!0},{key:"noteEnded",enabled:!0},{key:"org",enabled:!0},{key:"loc",enabled:!0},{key:"people",enabled:!0},{key:"topics",enabled:!0},{key:"tags",enabled:!0},{key:"emails",enabled:!0},{key:"granola_id",enabled:!0},{key:"title",enabled:!0},{key:"granola_url",enabled:!0}],st={syncDirectory:"Notes",authKeyPath:et(),filenameTemplate:"{created_date}_{title}",dateFormat:"YYYY-MM-DD",autoSyncFrequency:3e5,skipExistingNotes:!0,existingFileAction:"timestamp",filenameSeparator:" ",slashReplacement:"&",documentSyncLimit:100,includeFullTranscript:!1,includeMyNotes:!0,includeEnhancedNotes:!0,includeGranolaUrl:!0,includeEmails:!0,attendeeFilter:"all",excludeMyNameFromPeople:!0,autoDetectMyName:!0,myName:"",enableLocationDetection:!0,platformMappings:[],downloadAttachments:!0,enableCustomFrontmatter:!0,customCategory:"[[Meetings]]",customTags:"meetings",enableDailyNoteIntegration:!0,dailyNoteSectionName:"## Granola Meetings",frontmatterFields:nt},ct=["png","jpg","jpeg","gif","webp","svg","bmp"],b={image:"png","image/png":"png","image/jpeg":"jpg","image/jpg":"jpg","image/gif":"gif","image/webp":"webp","image/svg+xml":"svg","application/pdf":"pdf"};function j(d,i="JSON"){try{return{data:JSON.parse(d),error:null}}catch(e){let s=e instanceof Error?e.message:"Unknown error";return{data:null,error:`Failed to parse ${i}: ${s}`}}}function F(d){if(d==null)return"";let i=String(d);return/[:\[\]{}#&*!|>'"%@`\n]/.test(i)||i.trim()!==i?'"'+i.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"':i}function M(d,i){if(!d)return"";let e=new Date(d),s=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0");return i.replace(/YYYY/g,String(s)).replace(/YY/g,String(s).slice(-2)).replace(/MM/g,t).replace(/DD/g,n).replace(/HH/g,r).replace(/mm/g,a).replace(/ss/g,l)}function x(d){try{let i=new Date(d),e=i.getFullYear(),s=String(i.getMonth()+1).padStart(2,"0"),t=String(i.getDate()).padStart(2,"0"),n=String(i.getHours()).padStart(2,"0"),r=String(i.getMinutes()).padStart(2,"0");return`${e}-${s}-${t}T${n}:${r}`}catch(i){return null}}function ut(d,i){let e=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],s=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],n=["January","February","March","April","May","June","July","August","September","October","November","December"],r=d.getFullYear(),a=d.getMonth(),l=d.getDate(),c=d.getDay();return i.replace(/YYYY/g,String(r)).replace(/YY/g,String(r).slice(-2)).replace(/MMMM/g,n[a]).replace(/MMM/g,t[a]).replace(/MM/g,String(a+1).padStart(2,"0")).replace(/M(?![ao])/g,String(a+1)).replace(/dddd/g,s[c]).replace(/ddd/g,e[c]).replace(/DD/g,String(l).padStart(2,"0")).replace(/D(?![ae])/g,String(l))}function Et(d){let i=new Date(d);return[i.getHours(),i.getMinutes(),i.getSeconds()].map(e=>String(e).padStart(2,"0")).join(":")}function Tt(d){return d==="microphone"?"Me":"Them"}function dt(d){if(!d||d.length===0)return"*No transcript content available*";let i=d.slice().sort((a,l)=>{let c=new Date(a.start_timestamp||0),o=new Date(l.start_timestamp||0);return c.getTime()-o.getTime()}),e=[],s=null,t="",n=null,r=()=>{let a=t.trim().replace(/\s+/g," ");if(a&&s&&n){let l=Et(n),c=Tt(s);e.push(`**${c}** *(${l})*: ${a}`)}t="",s=null,n=null};for(let a of i){s&&s!==a.source&&r(),s||(s=a.source,n=a.start_timestamp);let l=a.text;l&&l.trim()&&(t+=t?` ${l}`:l)}return r(),e.length===0?"*No transcript content available*":e.join(`

`)}function gt(d){if(!d)return d;let i=[/uel([^l]|$)/i,/ael/i,/oel/i];return d.split(/(\s+)/).map(s=>{if(/^\s+$/.test(s))return s;for(let t of i)if(t.test(s))return s;return s.replace(/\bAe/g,"\xC4").replace(/\bOe/g,"\xD6").replace(/\bUe/g,"\xDC").replace(/ae/g,"\xE4").replace(/oe/g,"\xF6").replace(/ue/g,"\xFC")}).join("")}function I(d){if(!d||typeof d!="object"||!d.content)return"";let i=(e,s=0)=>{var a,l;if(!e||typeof e!="object")return"";let t=e.type||"",n=e.content||[],r=e.text||"";if(t==="heading"){let c=(l=(a=e.attrs)==null?void 0:a.level)!=null?l:1,o=n.map(u=>i(u,s)).join("");return"#".repeat(c)+" "+o+`

`}else{if(t==="paragraph")return n.map(o=>i(o,s)).join("")+`

`;if(t==="bulletList"){let c=[];for(let o of n)if(o.type==="listItem"){let u=pt(o,s);u&&c.push(u)}return c.join(`
`)+`

`}else return t==="text"?r:n.map(c=>i(c,s)).join("")}};return i(d)}function pt(d,i=0){if(!d||!d.content)return"";let e="  ".repeat(i),s="",t=!1;for(let r of d.content)if(r.type==="paragraph"){let a=(r.content||[]).map(l=>l.type==="text"&&l.text||"").join("").trim();a&&(s+=a)}else if(r.type==="bulletList"){t=!0;let a=[];for(let l of r.content||[])if(l.type==="listItem"){let c=pt(l,i+1);c&&a.push(c)}a.length>0&&(s+=`
`+a.join(`
`))}if(!s.trim())return"";let n=e+"- "+s.split(`
`)[0];if(t){let r=s.split(`
`);if(r.length>1){let a=r.slice(1).join(`
`);return n+`
`+a}}return n}function mt(d,i){var s;if(i){let t=i.toLowerCase().split(";")[0].trim();if(b[t])return b[t];let n=t.match(/^image\/(\w+)/);if(n)return n[1]}if(d.type&&b[d.type])return b[d.type];let e=(s=d.url)==null?void 0:s.match(/\.(\w{3,4})(?:\?|$)/);return e?e[1]:d.type==="image"||d.width||d.height?"png":"bin"}function $(d){return d.split("@")[0].replace(/[._-]/g," ").split(" ").map(i=>i.charAt(0).toUpperCase()+i.slice(1).toLowerCase()).join(" ")}var Ft=new Set(["gmail.com","googlemail.com","outlook.com","hotmail.com","live.com","msn.com","yahoo.com","yahoo.co.uk","yahoo.de","yahoo.fr","icloud.com","me.com","mac.com","aol.com","protonmail.com","proton.me","zoho.com","mail.com","gmx.com","gmx.de","gmx.net","web.de","t-online.de","posteo.de","fastmail.com","tutanota.com","tutamail.com"]);function ht(d){var n;if(!d||!d.includes("@"))return null;let i=(n=d.split("@")[1])==null?void 0:n.toLowerCase();if(!i||Ft.has(i))return null;let e=i.split(".");if(e.length<2)return null;let s;return e.length>=3&&["co","com","org","net","ac"].includes(e[e.length-2])?s=e.slice(0,-2).join("."):s=e.slice(0,-1).join("."),s&&s.replace(/[-_]/g," ").split(" ").map(r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase()).join(" ")||null}var y=require("obsidian");var Mt={category:"Category",type:"Type (empty)",date:"Date",dateEnd:"Date end",noteStarted:"Note started",noteEnded:"Note ended",org:"Organization",loc:"Location",people:"People",topics:"Topics (empty)",tags:"Tags",emails:"Emails",granola_id:"Granola ID",title:"Title",granola_url:"Granola URL"},U=class extends y.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;if(i.empty(),i.createEl("h3",{text:"Sync settings"}),new y.Setting(i).setName("Sync directory").setDesc("Directory where Granola notes will be synced").addText(t=>{t.setPlaceholder("Notes"),t.setValue(this.plugin.settings.syncDirectory),t.onChange(async n=>{this.plugin.settings.syncDirectory=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Auth key path").setDesc("Path to your Granola authentication key file (relative to home directory)").addText(t=>{t.setPlaceholder(et()),t.setValue(this.plugin.settings.authKeyPath),t.onChange(async n=>{this.plugin.settings.authKeyPath=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Auto-sync frequency").setDesc("How often to automatically sync notes").addDropdown(t=>{t.addOption("0","Never (manual only)"),t.addOption("60000","Every 1 minute"),t.addOption("300000","Every 5 minutes"),t.addOption("600000","Every 10 minutes"),t.addOption("1800000","Every 30 minutes"),t.addOption("3600000","Every 1 hour"),t.addOption("86400000","Every 24 hours"),t.setValue(String(this.plugin.settings.autoSyncFrequency)),t.onChange(async n=>{this.plugin.settings.autoSyncFrequency=parseInt(n),await this.plugin.saveSettings()})}),new y.Setting(i).setName("Document limit").setDesc(`Maximum number of documents to sync (${B}-${O})`).addText(t=>{t.setPlaceholder("100"),t.setValue(String(this.plugin.settings.documentSyncLimit)),t.onChange(async n=>{let r=parseInt(n);if(!isNaN(r)&&r>=B&&r<=O)this.plugin.settings.documentSyncLimit=r,await this.plugin.saveSettings();else if(!isNaN(r)){let a=Math.max(B,Math.min(O,r));this.plugin.settings.documentSyncLimit=a,t.setValue(String(a)),await this.plugin.saveSettings()}})}),new y.Setting(i).setName("Skip existing notes").setDesc("Don't update notes that already exist (preserves manual edits)").addToggle(t=>{t.setValue(this.plugin.settings.skipExistingNotes),t.onChange(async n=>{this.plugin.settings.skipExistingNotes=n,await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Filename settings"}),new y.Setting(i).setName("Filename template").setDesc("Use {title}, {created_date}, {updated_date}, {id}, etc.").addText(t=>{t.setPlaceholder("{created_date}_{title}"),t.setValue(this.plugin.settings.filenameTemplate),t.onChange(async n=>{this.plugin.settings.filenameTemplate=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Date format").setDesc("Format for dates. Use YYYY, MM, DD").addText(t=>{t.setPlaceholder("YYYY-MM-DD"),t.setValue(this.plugin.settings.dateFormat),t.onChange(async n=>{this.plugin.settings.dateFormat=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Word separator").setDesc("Character to separate words in filenames").addDropdown(t=>{t.addOption("_","Underscore (_)"),t.addOption("-","Hyphen (-)"),t.addOption(" ","Space"),t.addOption("","None"),t.setValue(this.plugin.settings.filenameSeparator),t.onChange(async n=>{this.plugin.settings.filenameSeparator=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Slash replacement").setDesc('Replace "/" in titles (e.g., "Jane / John" \u2192 "Jane & John")').addDropdown(t=>{t.addOption("&","Ampersand (&)"),t.addOption("-","Hyphen (-)"),t.addOption("+","Plus (+)"),t.addOption("~","Tilde (~)"),t.addOption("x","x"),t.addOption("","Remove"),t.setValue(this.plugin.settings.slashReplacement),t.onChange(async n=>{this.plugin.settings.slashReplacement=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("When filename exists").setDesc("What to do when a file with the same name exists").addDropdown(t=>{t.addOption("timestamp","Add timestamp"),t.addOption("skip","Skip"),t.setValue(this.plugin.settings.existingFileAction),t.onChange(async n=>{this.plugin.settings.existingFileAction=n,await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Note content"}),new y.Setting(i).setName("Include My Notes").setDesc("Include your personal notes from Granola").addToggle(t=>{t.setValue(this.plugin.settings.includeMyNotes),t.onChange(async n=>{this.plugin.settings.includeMyNotes=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Include Enhanced Notes").setDesc("Include AI-generated enhanced notes").addToggle(t=>{t.setValue(this.plugin.settings.includeEnhancedNotes),t.onChange(async n=>{this.plugin.settings.includeEnhancedNotes=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Include transcript").setDesc("Include full meeting transcript (slower sync)").addToggle(t=>{t.setValue(this.plugin.settings.includeFullTranscript),t.onChange(async n=>{this.plugin.settings.includeFullTranscript=n,await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Frontmatter"}),new y.Setting(i).setName("Include Granola URL").setDesc("Add link back to original Granola note").addToggle(t=>{t.setValue(this.plugin.settings.includeGranolaUrl),t.onChange(async n=>{this.plugin.settings.includeGranolaUrl=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Include emails").setDesc("Include attendee email addresses").addToggle(t=>{t.setValue(this.plugin.settings.includeEmails),t.onChange(async n=>{this.plugin.settings.includeEmails=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Attendee filter").setDesc("Filter attendees based on their calendar response status").addDropdown(t=>{t.addOption("all","Include everyone"),t.addOption("accepted","Only accepted"),t.addOption("accepted_tentative","Accepted + tentative"),t.addOption("exclude_declined","Exclude declined"),t.setValue(this.plugin.settings.attendeeFilter),t.onChange(async n=>{this.plugin.settings.attendeeFilter=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Exclude my name from people").setDesc("Filter out your name from the people list").addToggle(t=>{t.setValue(this.plugin.settings.excludeMyNameFromPeople),t.onChange(async n=>{this.plugin.settings.excludeMyNameFromPeople=n,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.excludeMyNameFromPeople&&(new y.Setting(i).setName("Auto-detect my name").setDesc('Automatically detect your name from calendar attendees (uses the attendee marked as "self")').addToggle(t=>{t.setValue(this.plugin.settings.autoDetectMyName),t.onChange(async n=>{this.plugin.settings.autoDetectMyName=n,await this.plugin.saveSettings(),this.display()})}),new y.Setting(i).setName("My name (override)").setDesc(this.plugin.settings.autoDetectMyName?"Leave empty to use auto-detected name, or enter a name to override":"Your name as it appears in Granola meetings").addText(t=>{t.setPlaceholder(this.plugin.settings.autoDetectMyName?"Auto-detected":"John Doe"),t.setValue(this.plugin.settings.myName),t.onChange(async n=>{this.plugin.settings.myName=n,await this.plugin.saveSettings()})})),new y.Setting(i).setName("Detect meeting platform").setDesc("Automatically detect Zoom, Google Meet, or Teams from calendar and add as wiki link to loc field").addToggle(t=>{t.setValue(this.plugin.settings.enableLocationDetection),t.onChange(async n=>{this.plugin.settings.enableLocationDetection=n,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.enableLocationDetection){let t=this.plugin.settings.platformMappings||[],n=i.createEl("div",{cls:"setting-item-description"});n.style.marginTop="-10px",n.style.marginBottom="10px",n.textContent="Map proxy URLs (e.g. Gong) to the actual meeting platform. Built-in: Zoom, Google Meet, Teams.";for(let r=0;r<t.length;r++){let a=t[r];new y.Setting(i).setName("URL contains \u2192 Platform").addText(l=>{l.setPlaceholder("gong.io"),l.setValue(a.urlPattern),l.onChange(async c=>{this.plugin.settings.platformMappings[r].urlPattern=c,await this.plugin.saveSettings()})}).addText(l=>{l.setPlaceholder("Zoom"),l.setValue(a.platform),l.onChange(async c=>{this.plugin.settings.platformMappings[r].platform=c,await this.plugin.saveSettings()})}).addExtraButton(l=>{l.setIcon("trash"),l.setTooltip("Remove mapping"),l.onClick(async()=>{this.plugin.settings.platformMappings.splice(r,1),await this.plugin.saveSettings(),this.display()})})}new y.Setting(i).addButton(r=>{r.setButtonText("Add platform mapping"),r.onClick(async()=>{this.plugin.settings.platformMappings||(this.plugin.settings.platformMappings=[]),this.plugin.settings.platformMappings.push({urlPattern:"",platform:""}),await this.plugin.saveSettings(),this.display()})})}if(i.createEl("h3",{text:"Attachments"}),new y.Setting(i).setName("Download attachments").setDesc("Download meeting attachments (screenshots, etc.) and embed them in the note").addToggle(t=>{t.setValue(this.plugin.settings.downloadAttachments),t.onChange(async n=>{this.plugin.settings.downloadAttachments=n,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.downloadAttachments){let t=this.app.vault.getConfig("attachmentFolderPath")||"Vault root",n=i.createEl("p",{text:"Attachments will be saved to: "+t,cls:"setting-item-description"});n.style.marginTop="-10px";let r=i.createEl("p",{text:"Configure attachment location in Obsidian Settings \u2192 Files & Links \u2192 Default location for new attachments",cls:"setting-item-description"});r.style.fontSize="0.85em"}i.createEl("h3",{text:"Custom frontmatter template"}),new y.Setting(i).setName("Enable custom frontmatter").setDesc("Add custom fields like category, type, org, loc, topics").addToggle(t=>{t.setValue(this.plugin.settings.enableCustomFrontmatter),t.onChange(async n=>{this.plugin.settings.enableCustomFrontmatter=n,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.enableCustomFrontmatter&&(new y.Setting(i).setName("Category").setDesc("Default category value (e.g., [[Meetings]])").addText(t=>{t.setPlaceholder("[[Meetings]]"),t.setValue(this.plugin.settings.customCategory),t.onChange(async n=>{this.plugin.settings.customCategory=n,await this.plugin.saveSettings()})}),new y.Setting(i).setName("Tags").setDesc("Default tags (comma-separated)").addText(t=>{t.setPlaceholder("meetings"),t.setValue(this.plugin.settings.customTags),t.onChange(async n=>{this.plugin.settings.customTags=n,await this.plugin.saveSettings()})})),i.createEl("h3",{text:"Frontmatter field order"});let e=i.createEl("p",{text:"Enable/disable fields and reorder them. Required fields cannot be disabled.",cls:"setting-item-description"});e.style.marginBottom="10px";let s=i.createDiv({cls:"granola-field-order-list"});for(let t=0;t<this.plugin.settings.frontmatterFields.length;t++){let n=this.plugin.settings.frontmatterFields[t],r=R.includes(n.key),a=t===0,l=t===this.plugin.settings.frontmatterFields.length-1,c=new y.Setting(s).setName(Mt[n.key]||n.key).setDesc(r?"Required":"");c.addToggle(o=>{o.setValue(n.enabled),o.setDisabled(r),o.onChange(async u=>{this.plugin.settings.frontmatterFields[t].enabled=u,await this.plugin.saveSettings()})}),c.addButton(o=>{o.setIcon("arrow-up"),o.setTooltip("Move up"),o.setDisabled(a),o.onClick(async()=>{if(t>0){let u=this.plugin.settings.frontmatterFields[t-1];this.plugin.settings.frontmatterFields[t-1]=this.plugin.settings.frontmatterFields[t],this.plugin.settings.frontmatterFields[t]=u,await this.plugin.saveSettings(),this.display()}})}),c.addButton(o=>{o.setIcon("arrow-down"),o.setTooltip("Move down"),o.setDisabled(l),o.onClick(async()=>{if(t<this.plugin.settings.frontmatterFields.length-1){let u=this.plugin.settings.frontmatterFields[t+1];this.plugin.settings.frontmatterFields[t+1]=this.plugin.settings.frontmatterFields[t],this.plugin.settings.frontmatterFields[t]=u,await this.plugin.saveSettings(),this.display()}})})}i.createEl("h3",{text:"Daily note integration"}),new y.Setting(i).setName("Enable daily note integration").setDesc("Add today's meetings to your daily note").addToggle(t=>{t.setValue(this.plugin.settings.enableDailyNoteIntegration),t.onChange(async n=>{this.plugin.settings.enableDailyNoteIntegration=n,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.enableDailyNoteIntegration&&new y.Setting(i).setName("Section heading").setDesc("Heading for the Granola meetings section in your daily note").addText(t=>{t.setPlaceholder("## Granola Meetings"),t.setValue(this.plugin.settings.dailyNoteSectionName),t.onChange(async n=>{this.plugin.settings.dailyNoteSectionName=n,await this.plugin.saveSettings()})}),i.createEl("h3",{text:"Actions"}),new y.Setting(i).setName("Sync now").setDesc("Manually sync your Granola notes").addButton(t=>{t.setButtonText("Sync now"),t.setCta(),t.onClick(async()=>{await this.plugin.syncNotes()})})}};var Y=class extends T.Plugin{constructor(){super(...arguments);this.settings=st;this.autoSyncInterval=null;this.statusBarItem=null;this.ribbonIconEl=null}async onload(){await this.loadSettings(),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar("Idle"),this.ribbonIconEl=this.addRibbonIcon("sync","Sync Granola notes",()=>{this.syncNotes()}),this.addCommand({id:"sync-granola-notes",name:"Sync Granola Notes",callback:()=>{this.syncNotes()}}),this.addSettingTab(new U(this.app,this)),window.setTimeout(()=>{this.setupAutoSync()},1e3)}onunload(){this.clearAutoSync(),this.statusBarItem&&(this.statusBarItem.remove(),this.statusBarItem=null),this.ribbonIconEl&&(this.ribbonIconEl.remove(),this.ribbonIconEl=null)}async loadSettings(){let e=await this.loadData();this.settings=Object.assign({},st,e),(!this.settings.frontmatterFields||this.settings.frontmatterFields.length===0)&&(this.settings.frontmatterFields=nt.map(s=>({...s})))}async saveSettings(){await this.saveData(this.settings),this.setupAutoSync()}updateStatusBar(e,s){if(!this.statusBarItem)return;let t="Granola: ";e==="Idle"?t+="Idle":e==="Syncing"?t+=typeof s=="string"?s:"Syncing...":e==="Complete"?(t+=s+" synced",window.setTimeout(()=>this.updateStatusBar("Idle"),3e3)):e==="Error"&&(t+="Error - "+(s||"sync failed"),window.setTimeout(()=>this.updateStatusBar("Idle"),5e3)),this.statusBarItem.setText(t)}setupAutoSync(){this.clearAutoSync(),this.settings.autoSyncFrequency>0&&(this.autoSyncInterval=window.setInterval(()=>{this.syncNotes().catch(e=>{console.error("Auto-sync failed:",e),this.updateStatusBar("Error","auto-sync failed")})},this.settings.autoSyncFrequency))}clearAutoSync(){this.autoSyncInterval&&(window.clearInterval(this.autoSyncInterval),this.autoSyncInterval=null)}async syncNotes(){try{this.updateStatusBar("Syncing"),await this.ensureDirectoryExists();let e=await this.loadCredentials();if(!e){this.updateStatusBar("Error","credentials failed");return}let s=await this.fetchGranolaDocuments(e);if(!s){this.updateStatusBar("Error","fetch failed");return}let t=0,n=[],r=new Date().toDateString();for(let a of s)try{if(this.settings.includeFullTranscript){let c=await this.fetchTranscript(e,a.id);a.transcript=dt(c)}if(await this.processDocument(a,e)&&t++,this.settings.enableDailyNoteIntegration&&a.created_at&&new Date(a.created_at).toDateString()===r){let o=await this.findExistingNoteByGranolaId(a.id);if(o){let u=new Date(a.created_at),p=String(u.getHours()).padStart(2,"0"),m=String(u.getMinutes()).padStart(2,"0");n.push({title:a.title||"Untitled Granola Note",actualFilePath:o.path,time:p+":"+m})}}}catch(l){console.error("Error processing document "+a.title+":",l)}this.settings.enableDailyNoteIntegration&&n.length>0&&await this.updateDailyNote(n),this.updateStatusBar("Complete",t)}catch(e){console.error("Granola sync failed:",e),this.updateStatusBar("Error","sync failed")}}async loadCredentials(){let e=H.homedir(),s=H.userInfo().username,t=[C.resolve(e,"Users",s,"Library/Application Support/Granola/supabase.json"),C.resolve(e,this.settings.authKeyPath),C.resolve(e,"Library/Application Support/Granola/supabase.json")];for(let n of t)try{if(!V.existsSync(n))continue;let r;try{r=V.readFileSync(n,"utf8")}catch(o){console.error("Failed to read credentials file:",o);continue}let{data:a,error:l}=j(r,"Granola credentials file");if(l||!a){console.error(l);continue}let c=null;if(a.workos_tokens)if(typeof a.workos_tokens=="string"){let{data:o}=j(a.workos_tokens,"WorkOS tokens");o&&(c=o.access_token)}else typeof a.workos_tokens=="object"&&(c=a.workos_tokens.access_token);if(!c&&a.cognito_tokens)if(typeof a.cognito_tokens=="string"){let{data:o}=j(a.cognito_tokens,"Cognito tokens");o&&(c=o.access_token)}else typeof a.cognito_tokens=="object"&&(c=a.cognito_tokens.access_token);if(c)return c}catch(r){console.error("Error loading credentials:",r);continue}return console.error("No valid Granola credentials found. Please ensure Granola is installed and you are logged in."),null}async fetchGranolaDocuments(e){try{let s=[],t=0,n=!0,r=this.settings.documentSyncLimit;for(;n&&s.length<r;){let l=(await(0,T.requestUrl)({url:`${Q}/v2/get-documents`,method:"POST",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json",Accept:"*/*","User-Agent":`Granola/${tt}`,"X-Client-Version":tt},body:JSON.stringify({limit:G,offset:t,include_last_viewed_panel:!0,include_panels:!0})})).json;if(!l||!l.docs)return s.length>0?s:null;let c=l.docs;s.push(...c),c.length<G||s.length>=r?n=!1:t+=G,s.length>100&&this.updateStatusBar("Syncing",`${s.length} docs fetched`)}return s.length>r&&(s.length=r),s}catch(s){return console.error("Error fetching documents:",s),null}}async fetchTranscript(e,s){try{return(await(0,T.requestUrl)({url:`${Q}/v1/get-document-transcript`,method:"POST",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({document_id:s})})).json}catch(t){return console.error("Error fetching transcript for document "+s+":",t),null}}extractPanelContent(e,s){if(e.panels&&Array.isArray(e.panels)){for(let t of e.panels)if(t.type===s&&t.content&&t.content.type==="doc")return t.content}return s==="my_notes"&&e.notes&&e.notes.type==="doc"?e.notes:s==="enhanced_notes"&&e.last_viewed_panel&&e.last_viewed_panel.content&&e.last_viewed_panel.content.type==="doc"?e.last_viewed_panel.content:null}buildResponseStatusMap(e){var t;let s=new Map;if((t=e.google_calendar_event)!=null&&t.attendees)for(let n of e.google_calendar_event.attendees)n.email&&n.responseStatus&&s.set(n.email.toLowerCase(),n.responseStatus);return s}shouldIncludeAttendee(e){let s=this.settings.attendeeFilter;if(s==="all"||!e)return!0;switch(s){case"accepted":return e==="accepted";case"accepted_tentative":return e==="accepted"||e==="tentative";case"exclude_declined":return e!=="declined";default:return!0}}extractCompanyNames(e){var n,r,a,l,c,o,u;let s=new Set,t=this.buildResponseStatusMap(e);try{let p=e.people;if(p&&"attendees"in p&&Array.isArray(p.attendees))for(let m of p.attendees){let S=(r=(n=m.email)==null?void 0:n.toLowerCase())!=null?r:null,f=S&&(a=t.get(S))!=null?a:null;if(this.shouldIncludeAttendee(f)){if((c=(l=m.details)==null?void 0:l.company)!=null&&c.name){let D=m.details.company.name.trim();if(D){s.add(D);continue}}if(S){let D=ht(S);D&&s.add(D)}}}if(p&&"creator"in p&&p.creator){let m=p.creator;if((u=(o=m.details)==null?void 0:o.company)!=null&&u.name){let S=m.details.company.name.trim();S&&s.add(S)}}}catch(p){console.error("Error extracting company names:",p)}return Array.from(s)}detectMeetingPlatform(e){var s,t;if(!this.settings.enableLocationDetection)return"";try{let n=e.google_calendar_event;if(!n)return"";let r=(n.location||"").toLowerCase(),a=(n.description||"").toLowerCase(),l=(n.hangoutLink||"").toLowerCase(),c=[];(s=n.conferenceData)!=null&&s.entryPoints&&(c=n.conferenceData.entryPoints.filter(u=>u.uri).map(u=>u.uri.toLowerCase()));let o=[r,a,l,...c].join(" ");if(((t=this.settings.platformMappings)==null?void 0:t.length)>0){for(let u of this.settings.platformMappings)if(u.urlPattern&&u.platform&&o.includes(u.urlPattern.toLowerCase()))return"[["+u.platform+"]]"}return o.includes("zoom.us")||o.includes("zoom.com")?"[[Zoom]]":o.includes("meet.google.com")||o.includes("hangouts.google.com")?"[[Google Meet]]":o.includes("teams.microsoft.com")||o.includes("teams.live.com")?"[[Teams]]":""}catch(n){return console.error("Error detecting meeting platform:",n),""}}getMyNameFromDocument(e){var s,t,n,r,a,l,c,o,u,p;try{if((s=e.google_calendar_event)!=null&&s.attendees){for(let m of e.google_calendar_event.attendees)if(m.self===!0){let S=(t=m.email)==null?void 0:t.toLowerCase(),f=e.people;if(f&&"creator"in f&&f.creator&&((n=f.creator.email)==null?void 0:n.toLowerCase())===S){if((l=(a=(r=f.creator.details)==null?void 0:r.person)==null?void 0:a.name)!=null&&l.fullName)return f.creator.details.person.name.fullName;if(f.creator.name)return f.creator.name}if(f&&"attendees"in f&&Array.isArray(f.attendees)){for(let D of f.attendees)if(((c=D.email)==null?void 0:c.toLowerCase())===S&&(p=(u=(o=D.details)==null?void 0:o.person)==null?void 0:u.name)!=null&&p.fullName)return D.details.person.name.fullName}if(m.displayName)return m.displayName;if(S)return $(S)}}return null}catch(m){return console.error("Error auto-detecting user name:",m),null}}getEffectiveMyName(e){if(this.settings.myName&&this.settings.myName.trim())return this.settings.myName.trim();if(this.settings.autoDetectMyName){let s=this.getMyNameFromDocument(e);if(s)return s}return""}extractAttendeeNames(e){var r,a,l,c,o,u,p,m,S,f,D,w;let s=[],t=new Set,n=this.buildResponseStatusMap(e);try{let h=e.people;if(Array.isArray(h))for(let g of h){let N=(a=(r=g.email)==null?void 0:r.toLowerCase())!=null?a:null,A=N&&(l=n.get(N))!=null?l:null;if(!this.shouldIncludeAttendee(A)){N&&t.add(N);continue}let _=null;if((o=(c=g.details)==null?void 0:c.person)!=null&&o.name){let v=g.details.person.name;v.fullName?_=v.fullName:v.givenName&&v.familyName?_=`${v.givenName} ${v.familyName}`:v.givenName&&(_=v.givenName)}else g.display_name?_=g.display_name:g.name&&(_=g.name);_&&!s.includes(_)&&(s.push(_),N&&t.add(N))}if((u=e.google_calendar_event)!=null&&u.attendees){for(let g of e.google_calendar_event.attendees)if(!(g.email&&t.has(g.email.toLowerCase()))){if(!this.shouldIncludeAttendee((p=g.responseStatus)!=null?p:null)){g.email&&t.add(g.email.toLowerCase());continue}g.displayName&&!s.includes(g.displayName)&&(s.push(g.displayName),g.email&&t.add(g.email.toLowerCase()))}}if(Array.isArray(h)){for(let g of h)if(g.email&&!t.has(g.email.toLowerCase())){let N=(m=n.get(g.email.toLowerCase()))!=null?m:null;if(!this.shouldIncludeAttendee(N)){t.add(g.email.toLowerCase());continue}if(!(g.name||g.display_name||((f=(S=g.details)==null?void 0:S.person)==null?void 0:f.name))){let _=$(g.email);s.includes(_)||(s.push(_),t.add(g.email.toLowerCase()))}}}if((D=e.google_calendar_event)!=null&&D.attendees){for(let g of e.google_calendar_event.attendees)if(g.email&&!t.has(g.email.toLowerCase())){if(!this.shouldIncludeAttendee((w=g.responseStatus)!=null?w:null)){t.add(g.email.toLowerCase());continue}if(!g.displayName){let N=$(g.email);s.includes(N)||(s.push(N),t.add(g.email.toLowerCase()))}}}return s}catch(h){return console.error("Error extracting attendee names:",h),[]}}extractAttendeeEmails(e){var r,a,l;let s=[],t=new Set,n=this.buildResponseStatusMap(e);try{let c=e.people;if(Array.isArray(c)){for(let o of c)if(o.email&&!t.has(o.email)){let u=(r=n.get(o.email.toLowerCase()))!=null?r:null;if(!this.shouldIncludeAttendee(u)){t.add(o.email);continue}s.push(o.email),t.add(o.email)}}if((a=e.google_calendar_event)!=null&&a.attendees){for(let o of e.google_calendar_event.attendees)if(o.email&&!t.has(o.email)){if(!this.shouldIncludeAttendee((l=o.responseStatus)!=null?l:null)){t.add(o.email);continue}s.push(o.email),t.add(o.email)}}}catch(c){console.error("Error extracting attendee emails:",c)}return s}generatePeopleLinks(e,s){if(!e||e.length===0)return[];let t=[],n=this.getEffectiveMyName(s);for(let r of e){if(r=gt(r),this.settings.excludeMyNameFromPeople&&n){let l=n.toLowerCase().trim(),c=r.toLowerCase().trim();if(c===l||c.includes(l)||l.includes(c))continue;let o=l.split(/[\s\-_]+/).filter(m=>m.length>1),u=c.split(/[\s\-_]+/).filter(m=>m.length>1),p=o.filter(m=>u.some(S=>S.includes(m)||m.includes(S)));if(p.length>=Math.min(o.length,u.length)&&p.length>=2)continue}let a=`[[${r}]]`;t.includes(a)||t.push(a)}return t}getAttachmentFolder(e){let s=this.app.vault.getConfig("attachmentFolderPath")||"";if(!s||s==="/")return"";if(s==="./")return e;if(s.startsWith("./")){let t=s.slice(2);return e?C.join(e,t):t}else return s}async downloadAttachments(e,s,t){var l,c;if(!this.settings.downloadAttachments)return[];let n=e.attachments;if(!n||!Array.isArray(n)||n.length===0)return[];let r=[],a=this.getAttachmentFolder(t);try{a&&(this.app.vault.getFolderByPath(a)||await this.app.vault.createFolder(a));for(let o=0;o<n.length;o++){let u=n[o];try{let p=u.url||u.file_url||u.download_url;if(!p){console.warn("Attachment has no URL:",u);continue}let m=p.includes("cloudfront.net")||p.includes("cdn."),S={url:p,method:"GET"};m||(S.headers={Authorization:"Bearer "+s});let f=await(0,T.requestUrl)(S);if(f.arrayBuffer){let D=((l=f.headers)==null?void 0:l["content-type"])||((c=f.headers)==null?void 0:c["Content-Type"]),w=mt(u,D),h=u.filename||u.name;h||(h=`attachment_${o+1}`),h=h.replace(/\.\w{3,4}$/,"");let g=e.created_at?M(e.created_at,"YYYY-MM-DD_HH-mm"):"",N=g?`${g}_${h}.${w}`:`${h}.${w}`,A=a?C.join(a,N):N;this.app.vault.getAbstractFileByPath(A)||await this.app.vault.createBinary(A,f.arrayBuffer),r.push(N)}else console.warn("No data received for attachment:",p)}catch(p){console.error("Error downloading attachment:",u.url,p)}}}catch(o){console.error("Error processing attachments:",o)}return r}generateFilename(e){let s=e.title||"Untitled Granola Note",t=e.id||"unknown_id",n="",r="",a="",l="",c="",o="";e.created_at&&(n=M(e.created_at,this.settings.dateFormat),a=M(e.created_at,"HH-mm-ss"),c=M(e.created_at,this.settings.dateFormat+"_HH-mm-ss")),e.updated_at&&(r=M(e.updated_at,this.settings.dateFormat),l=M(e.updated_at,"HH-mm-ss"),o=M(e.updated_at,this.settings.dateFormat+"_HH-mm-ss"));let u=this.settings.filenameTemplate.replace(/{title}/g,s).replace(/{id}/g,t).replace(/{created_date}/g,n).replace(/{updated_date}/g,r).replace(/{created_time}/g,a).replace(/{updated_time}/g,l).replace(/{created_datetime}/g,c).replace(/{updated_datetime}/g,o);this.settings.slashReplacement?u=u.replace(/\s*\/\s*/g,` ${this.settings.slashReplacement} `):u=u.replace(/\s*\/\s*/g," ");let p=/[:\\|?*"]/g;return u=u.replace(p,""),u=u.replace(/\s+/g,this.settings.filenameSeparator),u}buildNoteContent(e,s,t=[]){let n=[],r=e.title||"Untitled Granola Note";n.push("# "+r);let a=this.extractPanelContent(e,"my_notes");if(a&&this.settings.includeMyNotes){let c=I(a);c&&c.trim()&&n.push(`
## My Notes

`+c.trim())}let l=this.extractPanelContent(e,"enhanced_notes");if(l&&this.settings.includeEnhancedNotes){let c=I(l);c&&c.trim()&&(a&&this.settings.includeMyNotes?n.push(`
## Enhanced Notes

`+c.trim()):n.push(`
`+c.trim()))}if(this.settings.includeFullTranscript&&s&&s!=="no_transcript"&&n.push(`
## Transcript

`+s),t.length>0){let c=t.map(o=>{var p;let u=((p=o.split(".").pop())==null?void 0:p.toLowerCase())||"";return ct.includes(u)?"![["+o+"]]":"[["+o+"]]"});n.push(`
## Attachments

`+c.join(`
`))}return n.join(`
`)}isFieldEnabled(e){let s=this.settings.frontmatterFields.find(t=>t.key===e);return s?R.includes(e)?!0:s.enabled:!1}buildFrontmatter(e,s=[]){var D,w;let t=e.title||"Untitled Granola Note",n=e.id||"unknown_id",r=this.extractAttendeeNames(e),a=this.generatePeopleLinks(r,e),l=this.extractAttendeeEmails(e),c=this.extractCompanyNames(e),o=this.detectMeetingPlatform(e),u=e.google_calendar_event,p=(D=u==null?void 0:u.start)==null?void 0:D.dateTime,m=(w=u==null?void 0:u.end)==null?void 0:w.dateTime,S={category:()=>this.settings.customCategory?`category:
  - `+F(this.settings.customCategory)+`
`:null,type:()=>`type:
`,date:()=>p?"date: "+x(p)+`
`:e.created_at?"date: "+x(e.created_at)+`
`:`date:
`,dateEnd:()=>m?"dateEnd: "+x(m)+`
`:`dateEnd:
`,noteStarted:()=>e.created_at?"noteStarted: "+x(e.created_at)+`
`:`noteStarted:
`,noteEnded:()=>e.updated_at?"noteEnded: "+x(e.updated_at)+`
`:`noteEnded:
`,org:()=>{let h=`org:
`;if(c.length>0)for(let g of c)h+="  - "+F("[["+g+"]]")+`
`;return h},loc:()=>o?`loc:
  - `+F(o)+`
`:`loc:
`,people:()=>{let h=`people:
`;if(a.length>0)for(let g of a)h+="  - "+F(g)+`
`;return h},topics:()=>`topics:
`,tags:()=>{if(!this.settings.customTags)return null;let h=`tags:
`,g=this.settings.customTags.split(",").map(N=>N.trim()).filter(N=>N);for(let N of g)h+="  - "+F(N)+`
`;return h},emails:()=>{if(!this.settings.includeEmails||l.length===0)return null;let h=`emails:
`;for(let g of l)h+="  - "+F(g)+`
`;return h},granola_id:()=>"granola_id: "+F(n)+`
`,title:()=>"title: "+F(t)+`
`,granola_url:()=>this.settings.includeGranolaUrl?"granola_url: https://notes.granola.ai/d/"+n+`
`:null},f=`---
`;for(let h of this.settings.frontmatterFields){if(!this.isFieldEnabled(h.key))continue;let g=S[h.key];if(g){let N=g();N!==null&&(f+=N)}}return f+=`---
`,f}async findExistingNoteByGranolaId(e){var n;let s=this.app.vault.getFolderByPath(this.settings.syncDirectory);if(!s)return null;let t=s.children.filter(r=>r instanceof T.TFile&&r.extension==="md");for(let r of t)try{let a=this.app.metadataCache.getFileCache(r);if((n=a==null?void 0:a.frontmatter)!=null&&n.granola_id&&String(a.frontmatter.granola_id).trim()===e)return r}catch(a){console.error("Error checking file for Granola ID:",r.path,a)}return null}async processDocument(e,s){var t,n;try{let r=e.title||"Untitled Granola Note",a=e.id||"unknown_id",l=e.transcript||"no_transcript",c=this.extractPanelContent(e,"my_notes"),o=this.extractPanelContent(e,"enhanced_notes"),u=c?I(c).trim():"",p=o?I(o).trim():"",m=!!u&&this.settings.includeMyNotes,S=!!p&&this.settings.includeEnhancedNotes,f=this.settings.includeFullTranscript&&l&&l!=="no_transcript",D=this.settings.downloadAttachments&&e.attachments&&e.attachments.length>0;if(!m&&!S&&!f&&!D)return!1;let w=await this.downloadAttachments(e,s,this.settings.syncDirectory),h=await this.findExistingNoteByGranolaId(a);if(h){if(this.settings.skipExistingNotes){let k=this.app.metadataCache.getFileCache(h),it=(t=k==null?void 0:k.frontmatter)==null?void 0:t.noteEnded,z=x(e.updated_at);if(it&&z&&z>it){let rt=this.buildNoteContent(e,l,w);await this.app.vault.process(h,ft=>{let ot=ft.match(/^---\n([\s\S]*?)\n---\n/);if(ot){let X=ot[1];return X=X.replace(/^noteEnded:.*$/m,"noteEnded: "+z),`---
`+X+`
---
`+rt}return this.buildFrontmatter(e,w)+rt})}return!0}let E=this.buildFrontmatter(e,w),q=this.buildNoteContent(e,l,w),W=E+q;return await this.app.vault.process(h,()=>W),!0}let g=this.buildFrontmatter(e,w),N=this.buildNoteContent(e,l,w),A=g+N,_=this.generateFilename(e)+".md",v=this.settings.syncDirectory,at=C.join(v,_),J=at,P=this.app.vault.getAbstractFileByPath(at);if(P&&P instanceof T.TFile){try{let E=this.app.metadataCache.getFileCache(P);if((n=E==null?void 0:E.frontmatter)!=null&&n.granola_id&&String(E.frontmatter.granola_id).trim()===a)return await this.app.vault.modify(P,A),!0}catch(E){console.error("Error checking existing file:",E)}if(this.settings.existingFileAction==="skip")return!1;if(this.settings.existingFileAction==="timestamp"){let E=M(e.created_at,"HH-mm"),W=this.generateFilename(e)+"_"+E+".md";if(J=C.join(v,W),this.app.vault.getAbstractFileByPath(J))return!1}}return await this.app.vault.create(J,A),!0}catch(r){return console.error("Error processing document:",r),!1}}async ensureDirectoryExists(){try{this.app.vault.getFolderByPath(this.settings.syncDirectory)||await this.app.vault.createFolder(this.settings.syncDirectory)}catch(e){console.error("Error creating directory:",e)}}async updateDailyNote(e){try{let s=await this.getDailyNote();if(!s)return;let t=await this.app.vault.read(s),n=this.settings.dailyNoteSectionName,r=e.sort((u,p)=>u.time.localeCompare(p.time)).map(u=>"- "+u.time+" [["+u.actualFilePath+"|"+u.title+"]]").join(`
`),a=n+`
`+r,l=this.app.metadataCache.getFileCache(s),c=(l==null?void 0:l.headings)||[],o=c.find(u=>u.heading.trim()===n.replace(/^#+\s*/,"").trim());if(o){let u=t.split(`
`),p=o.position.start.line,m=u.length;for(let D of c)if(D.position.start.line>p&&D.level<=o.level){m=D.position.start.line;break}let S=u.slice(0,p).join(`
`),f=u.slice(m).join(`
`);t=S+`
`+a+`
`+f}else t+=`

`+a;await this.app.vault.process(s,()=>t)}catch(s){console.error("Error updating daily note:",s)}}async getDailyNote(){var e;try{let s=new Date,t=this.app.internalPlugins.getPluginById("daily-notes");if(t!=null&&t.enabled){let o=((e=t.instance)==null?void 0:e.options)||{},u=o.format||"YYYY-MM-DD",p=o.folder||"",m=ut(s,u),S=p?`${p}/${m}.md`:`${m}.md`,f=this.app.vault.getAbstractFileByPath(S);if(f instanceof T.TFile)return f;let w=this.app.vault.getMarkdownFiles().find(h=>h.basename===m);if(w)return w}let n=s.getFullYear(),r=String(s.getMonth()+1).padStart(2,"0"),a=String(s.getDate()).padStart(2,"0"),l=[`${n}-${r}-${a}`,`${a}-${r}-${n}`,`${r}-${a}-${n}`],c=this.app.vault.getMarkdownFiles();for(let o of c)if(o.path.includes("Daily")){for(let u of l)if(o.path.includes(u))return o}return null}catch(s){return console.error("Error getting daily note:",s),null}}};
