/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var pt=Object.create;var G=Object.defineProperty;var ht=Object.getOwnPropertyDescriptor;var ft=Object.getOwnPropertyNames;var yt=Object.getPrototypeOf,St=Object.prototype.hasOwnProperty;var Nt=(d,a)=>{for(var t in a)G(d,t,{get:a[t],enumerable:!0})},rt=(d,a,t,e)=>{if(a&&typeof a=="object"||typeof a=="function")for(let n of ft(a))!St.call(d,n)&&n!==t&&G(d,n,{get:()=>a[n],enumerable:!(e=ht(a,n))||e.enumerable});return d};var z=(d,a,t)=>(t=d!=null?pt(yt(d)):{},rt(a||!d||!d.__esModule?G(t,"default",{value:d,enumerable:!0}):t,d)),wt=d=>rt(G({},"__esModule",{value:!0}),d);var vt={};Nt(vt,{default:()=>U});module.exports=wt(vt);var M=require("obsidian"),F=z(require("path")),V=z(require("fs")),H=z(require("os"));var K=require("obsidian"),L=100,O=1e3,B=1,Z="https://api.granola.ai",Q="5.354.0";function tt(){return K.Platform.isWin?"AppData/Roaming/Granola/supabase.json":K.Platform.isLinux?".config/Granola/supabase.json":"Library/Application Support/Granola/supabase.json"}var et={syncDirectory:"Notes",authKeyPath:tt(),filenameTemplate:"{created_date}_{title}",dateFormat:"YYYY-MM-DD",autoSyncFrequency:3e5,skipExistingNotes:!0,existingFileAction:"timestamp",filenameSeparator:" ",slashReplacement:"&",documentSyncLimit:100,includeFullTranscript:!1,includeMyNotes:!0,includeEnhancedNotes:!0,includeGranolaUrl:!0,includeEmails:!0,attendeeFilter:"all",excludeMyNameFromPeople:!0,autoDetectMyName:!0,myName:"",enableLocationDetection:!0,downloadAttachments:!0,enableCustomFrontmatter:!0,customCategory:"[[Meetings]]",customTags:"meetings",enableDailyNoteIntegration:!0,dailyNoteSectionName:"## Granola Meetings"},ot=["png","jpg","jpeg","gif","webp","svg","bmp"],b={image:"png","image/png":"png","image/jpeg":"jpg","image/jpg":"jpg","image/gif":"gif","image/webp":"webp","image/svg+xml":"svg","application/pdf":"pdf"};function $(d,a="JSON"){try{return{data:JSON.parse(d),error:null}}catch(t){let e=t instanceof Error?t.message:"Unknown error";return{data:null,error:`Failed to parse ${a}: ${e}`}}}function E(d){if(d==null)return"";let a=String(d);return/[:\[\]{}#&*!|>'"%@`\n]/.test(a)||a.trim()!==a?'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"':a}function C(d,a){if(!d)return"";let t=new Date(d),e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),l=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0");return a.replace(/YYYY/g,String(e)).replace(/YY/g,String(e).slice(-2)).replace(/MM/g,n).replace(/DD/g,i).replace(/HH/g,l).replace(/mm/g,s).replace(/ss/g,r)}function A(d){try{let a=new Date(d),t=a.getFullYear(),e=String(a.getMonth()+1).padStart(2,"0"),n=String(a.getDate()).padStart(2,"0"),i=String(a.getHours()).padStart(2,"0"),l=String(a.getMinutes()).padStart(2,"0");return`${t}-${e}-${n}T${i}:${l}`}catch(a){return null}}function lt(d,a){let t=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],e=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],i=["January","February","March","April","May","June","July","August","September","October","November","December"],l=d.getFullYear(),s=d.getMonth(),r=d.getDate(),o=d.getDay();return a.replace(/YYYY/g,String(l)).replace(/YY/g,String(l).slice(-2)).replace(/MMMM/g,i[s]).replace(/MMM/g,n[s]).replace(/MM/g,String(s+1).padStart(2,"0")).replace(/M(?![ao])/g,String(s+1)).replace(/dddd/g,e[o]).replace(/ddd/g,t[o]).replace(/DD/g,String(r).padStart(2,"0")).replace(/D(?![ae])/g,String(r))}function Dt(d){let a=new Date(d);return[a.getHours(),a.getMinutes(),a.getSeconds()].map(t=>String(t).padStart(2,"0")).join(":")}function _t(d){switch(d){case"microphone":return"Me";case"system":default:return"Them"}}function ct(d){if(!d||d.length===0)return"*No transcript content available*";let a=d.slice().sort((s,r)=>{let o=new Date(s.start_timestamp||0),c=new Date(r.start_timestamp||0);return o.getTime()-c.getTime()}),t=[],e=null,n="",i=null,l=()=>{let s=n.trim().replace(/\s+/g," ");if(s&&e&&i){let r=Dt(i),o=_t(e);t.push(`**${o}** *(${r})*: ${s}`)}n="",e=null,i=null};for(let s of a){e&&e!==s.source&&l(),e||(e=s.source,i=s.start_timestamp);let r=s.text;r&&r.trim()&&(n+=n?` ${r}`:r)}return l(),t.length===0?"*No transcript content available*":t.join(`

`)}function ut(d){if(!d)return d;let a=[/uel([^l]|$)/i,/ael/i,/oel/i];return d.split(/(\s+)/).map(e=>{if(/^\s+$/.test(e))return e;for(let n of a)if(n.test(e))return e;return e.replace(/\bAe/g,"\xC4").replace(/\bOe/g,"\xD6").replace(/\bUe/g,"\xDC").replace(/ae/g,"\xE4").replace(/oe/g,"\xF6").replace(/ue/g,"\xFC")}).join("")}function P(d){if(!d||typeof d!="object"||!d.content)return"";let a=(t,e=0)=>{var s,r;if(!t||typeof t!="object")return"";let n=t.type||"",i=t.content||[],l=t.text||"";if(n==="heading"){let o=(r=(s=t.attrs)==null?void 0:s.level)!=null?r:1,c=i.map(u=>a(u,e)).join("");return"#".repeat(o)+" "+c+`

`}else{if(n==="paragraph")return i.map(c=>a(c,e)).join("")+`

`;if(n==="bulletList"){let o=[];for(let c of i)if(c.type==="listItem"){let u=dt(c,e);u&&o.push(u)}return o.join(`
`)+`

`}else return n==="text"?l:i.map(o=>a(o,e)).join("")}};return a(d)}function dt(d,a=0){if(!d||!d.content)return"";let t="  ".repeat(a),e="",n=!1;for(let l of d.content)if(l.type==="paragraph"){let s=(l.content||[]).map(r=>r.type==="text"&&r.text||"").join("").trim();s&&(e+=s)}else if(l.type==="bulletList"){n=!0;let s=[];for(let r of l.content||[])if(r.type==="listItem"){let o=dt(r,a+1);o&&s.push(o)}s.length>0&&(e+=`
`+s.join(`
`))}if(!e.trim())return"";let i=t+"- "+e.split(`
`)[0];if(n){let l=e.split(`
`);if(l.length>1){let s=l.slice(1).join(`
`);return i+`
`+s}}return i}function gt(d,a){var e;if(a){let n=a.toLowerCase().split(";")[0].trim();if(b[n])return b[n];let i=n.match(/^image\/(\w+)/);if(i)return i[1]}if(d.type&&b[d.type])return b[d.type];let t=(e=d.url)==null?void 0:e.match(/\.(\w{3,4})(?:\?|$)/);return t?t[1]:d.type==="image"||d.width||d.height?"png":"bin"}function j(d){return d.split("@")[0].replace(/[._-]/g," ").split(" ").map(a=>a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()).join(" ")}var y=require("obsidian");var Y=class extends y.PluginSettingTab{constructor(a,t){super(a,t),this.plugin=t}display(){let{containerEl:a}=this;if(a.empty(),a.createEl("h3",{text:"Sync settings"}),new y.Setting(a).setName("Sync directory").setDesc("Directory where Granola notes will be synced").addText(t=>{t.setPlaceholder("Notes"),t.setValue(this.plugin.settings.syncDirectory),t.onChange(async e=>{this.plugin.settings.syncDirectory=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Auth key path").setDesc("Path to your Granola authentication key file (relative to home directory)").addText(t=>{t.setPlaceholder(tt()),t.setValue(this.plugin.settings.authKeyPath),t.onChange(async e=>{this.plugin.settings.authKeyPath=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Auto-sync frequency").setDesc("How often to automatically sync notes").addDropdown(t=>{t.addOption("0","Never (manual only)"),t.addOption("60000","Every 1 minute"),t.addOption("300000","Every 5 minutes"),t.addOption("600000","Every 10 minutes"),t.addOption("1800000","Every 30 minutes"),t.addOption("3600000","Every 1 hour"),t.addOption("86400000","Every 24 hours"),t.setValue(String(this.plugin.settings.autoSyncFrequency)),t.onChange(async e=>{this.plugin.settings.autoSyncFrequency=parseInt(e),await this.plugin.saveSettings()})}),new y.Setting(a).setName("Document limit").setDesc(`Maximum number of documents to sync (${B}-${O})`).addText(t=>{t.setPlaceholder("100"),t.setValue(String(this.plugin.settings.documentSyncLimit)),t.onChange(async e=>{let n=parseInt(e);if(!isNaN(n)&&n>=B&&n<=O)this.plugin.settings.documentSyncLimit=n,await this.plugin.saveSettings();else if(!isNaN(n)){let i=Math.max(B,Math.min(O,n));this.plugin.settings.documentSyncLimit=i,t.setValue(String(i)),await this.plugin.saveSettings()}})}),new y.Setting(a).setName("Skip existing notes").setDesc("Don't update notes that already exist (preserves manual edits)").addToggle(t=>{t.setValue(this.plugin.settings.skipExistingNotes),t.onChange(async e=>{this.plugin.settings.skipExistingNotes=e,await this.plugin.saveSettings()})}),a.createEl("h3",{text:"Filename settings"}),new y.Setting(a).setName("Filename template").setDesc("Use {title}, {created_date}, {updated_date}, {id}, etc.").addText(t=>{t.setPlaceholder("{created_date}_{title}"),t.setValue(this.plugin.settings.filenameTemplate),t.onChange(async e=>{this.plugin.settings.filenameTemplate=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Date format").setDesc("Format for dates. Use YYYY, MM, DD").addText(t=>{t.setPlaceholder("YYYY-MM-DD"),t.setValue(this.plugin.settings.dateFormat),t.onChange(async e=>{this.plugin.settings.dateFormat=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Word separator").setDesc("Character to separate words in filenames").addDropdown(t=>{t.addOption("_","Underscore (_)"),t.addOption("-","Hyphen (-)"),t.addOption(" ","Space"),t.addOption("","None"),t.setValue(this.plugin.settings.filenameSeparator),t.onChange(async e=>{this.plugin.settings.filenameSeparator=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Slash replacement").setDesc('Replace "/" in titles (e.g., "Jane / John" \u2192 "Jane & John")').addDropdown(t=>{t.addOption("&","Ampersand (&)"),t.addOption("-","Hyphen (-)"),t.addOption("+","Plus (+)"),t.addOption("~","Tilde (~)"),t.addOption("x","x"),t.addOption("","Remove"),t.setValue(this.plugin.settings.slashReplacement),t.onChange(async e=>{this.plugin.settings.slashReplacement=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("When filename exists").setDesc("What to do when a file with the same name exists").addDropdown(t=>{t.addOption("timestamp","Add timestamp"),t.addOption("skip","Skip"),t.setValue(this.plugin.settings.existingFileAction),t.onChange(async e=>{this.plugin.settings.existingFileAction=e,await this.plugin.saveSettings()})}),a.createEl("h3",{text:"Note content"}),new y.Setting(a).setName("Include My Notes").setDesc("Include your personal notes from Granola").addToggle(t=>{t.setValue(this.plugin.settings.includeMyNotes),t.onChange(async e=>{this.plugin.settings.includeMyNotes=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Include Enhanced Notes").setDesc("Include AI-generated enhanced notes").addToggle(t=>{t.setValue(this.plugin.settings.includeEnhancedNotes),t.onChange(async e=>{this.plugin.settings.includeEnhancedNotes=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Include transcript").setDesc("Include full meeting transcript (slower sync)").addToggle(t=>{t.setValue(this.plugin.settings.includeFullTranscript),t.onChange(async e=>{this.plugin.settings.includeFullTranscript=e,await this.plugin.saveSettings()})}),a.createEl("h3",{text:"Frontmatter"}),new y.Setting(a).setName("Include Granola URL").setDesc("Add link back to original Granola note").addToggle(t=>{t.setValue(this.plugin.settings.includeGranolaUrl),t.onChange(async e=>{this.plugin.settings.includeGranolaUrl=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Include emails").setDesc("Include attendee email addresses").addToggle(t=>{t.setValue(this.plugin.settings.includeEmails),t.onChange(async e=>{this.plugin.settings.includeEmails=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Attendee filter").setDesc("Filter attendees based on their calendar response status").addDropdown(t=>{t.addOption("all","Include everyone"),t.addOption("accepted","Only accepted"),t.addOption("accepted_tentative","Accepted + tentative"),t.addOption("exclude_declined","Exclude declined"),t.setValue(this.plugin.settings.attendeeFilter),t.onChange(async e=>{this.plugin.settings.attendeeFilter=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Exclude my name from people").setDesc("Filter out your name from the people list").addToggle(t=>{t.setValue(this.plugin.settings.excludeMyNameFromPeople),t.onChange(async e=>{this.plugin.settings.excludeMyNameFromPeople=e,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.excludeMyNameFromPeople&&(new y.Setting(a).setName("Auto-detect my name").setDesc('Automatically detect your name from calendar attendees (uses the attendee marked as "self")').addToggle(t=>{t.setValue(this.plugin.settings.autoDetectMyName),t.onChange(async e=>{this.plugin.settings.autoDetectMyName=e,await this.plugin.saveSettings(),this.display()})}),new y.Setting(a).setName("My name (override)").setDesc(this.plugin.settings.autoDetectMyName?"Leave empty to use auto-detected name, or enter a name to override":"Your name as it appears in Granola meetings").addText(t=>{t.setPlaceholder(this.plugin.settings.autoDetectMyName?"Auto-detected":"John Doe"),t.setValue(this.plugin.settings.myName),t.onChange(async e=>{this.plugin.settings.myName=e,await this.plugin.saveSettings()})})),new y.Setting(a).setName("Detect meeting platform").setDesc("Automatically detect Zoom, Google Meet, or Teams from calendar and add as wiki link to loc field").addToggle(t=>{t.setValue(this.plugin.settings.enableLocationDetection),t.onChange(async e=>{this.plugin.settings.enableLocationDetection=e,await this.plugin.saveSettings()})}),a.createEl("h3",{text:"Attachments"}),new y.Setting(a).setName("Download attachments").setDesc("Download meeting attachments (screenshots, etc.) and embed them in the note").addToggle(t=>{t.setValue(this.plugin.settings.downloadAttachments),t.onChange(async e=>{this.plugin.settings.downloadAttachments=e,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.downloadAttachments){let t=this.app.vault.getConfig("attachmentFolderPath")||"Vault root",e=a.createEl("p",{text:"Attachments will be saved to: "+t,cls:"setting-item-description"});e.style.marginTop="-10px";let n=a.createEl("p",{text:"Configure attachment location in Obsidian Settings \u2192 Files & Links \u2192 Default location for new attachments",cls:"setting-item-description"});n.style.fontSize="0.85em"}a.createEl("h3",{text:"Custom frontmatter template"}),new y.Setting(a).setName("Enable custom frontmatter").setDesc("Add custom fields like category, type, org, loc, topics").addToggle(t=>{t.setValue(this.plugin.settings.enableCustomFrontmatter),t.onChange(async e=>{this.plugin.settings.enableCustomFrontmatter=e,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.enableCustomFrontmatter&&(new y.Setting(a).setName("Category").setDesc("Default category value (e.g., [[Meetings]])").addText(t=>{t.setPlaceholder("[[Meetings]]"),t.setValue(this.plugin.settings.customCategory),t.onChange(async e=>{this.plugin.settings.customCategory=e,await this.plugin.saveSettings()})}),new y.Setting(a).setName("Tags").setDesc("Default tags (comma-separated)").addText(t=>{t.setPlaceholder("meetings"),t.setValue(this.plugin.settings.customTags),t.onChange(async e=>{this.plugin.settings.customTags=e,await this.plugin.saveSettings()})})),a.createEl("h3",{text:"Daily note integration"}),new y.Setting(a).setName("Enable daily note integration").setDesc("Add today's meetings to your daily note").addToggle(t=>{t.setValue(this.plugin.settings.enableDailyNoteIntegration),t.onChange(async e=>{this.plugin.settings.enableDailyNoteIntegration=e,await this.plugin.saveSettings(),this.display()})}),this.plugin.settings.enableDailyNoteIntegration&&new y.Setting(a).setName("Section heading").setDesc("Heading for the Granola meetings section in your daily note").addText(t=>{t.setPlaceholder("## Granola Meetings"),t.setValue(this.plugin.settings.dailyNoteSectionName),t.onChange(async e=>{this.plugin.settings.dailyNoteSectionName=e,await this.plugin.saveSettings()})}),a.createEl("h3",{text:"Actions"}),new y.Setting(a).setName("Sync now").setDesc("Manually sync your Granola notes").addButton(t=>{t.setButtonText("Sync now"),t.setCta(),t.onClick(async()=>{await this.plugin.syncNotes()})})}};var U=class extends M.Plugin{constructor(){super(...arguments);this.settings=et;this.autoSyncInterval=null;this.statusBarItem=null;this.ribbonIconEl=null}async onload(){await this.loadSettings(),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar("Idle"),this.ribbonIconEl=this.addRibbonIcon("sync","Sync Granola notes",()=>{this.syncNotes()}),this.addCommand({id:"sync-granola-notes",name:"Sync Granola Notes",callback:()=>{this.syncNotes()}}),this.addSettingTab(new Y(this.app,this)),window.setTimeout(()=>{this.setupAutoSync()},1e3)}onunload(){this.clearAutoSync(),this.statusBarItem&&(this.statusBarItem.remove(),this.statusBarItem=null),this.ribbonIconEl&&(this.ribbonIconEl.remove(),this.ribbonIconEl=null)}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},et,t)}async saveSettings(){await this.saveData(this.settings),this.setupAutoSync()}updateStatusBar(t,e){if(!this.statusBarItem)return;let n="Granola: ";t==="Idle"?n+="Idle":t==="Syncing"?n+=typeof e=="string"?e:"Syncing...":t==="Complete"?(n+=e+" synced",window.setTimeout(()=>this.updateStatusBar("Idle"),3e3)):t==="Error"&&(n+="Error - "+(e||"sync failed"),window.setTimeout(()=>this.updateStatusBar("Idle"),5e3)),this.statusBarItem.setText(n)}setupAutoSync(){this.clearAutoSync(),this.settings.autoSyncFrequency>0&&(this.autoSyncInterval=window.setInterval(()=>{this.syncNotes().catch(t=>{console.error("Auto-sync failed:",t),this.updateStatusBar("Error","auto-sync failed")})},this.settings.autoSyncFrequency))}clearAutoSync(){this.autoSyncInterval&&(window.clearInterval(this.autoSyncInterval),this.autoSyncInterval=null)}async syncNotes(){try{this.updateStatusBar("Syncing"),await this.ensureDirectoryExists();let t=await this.loadCredentials();if(!t){this.updateStatusBar("Error","credentials failed");return}let e=await this.fetchGranolaDocuments(t);if(!e){this.updateStatusBar("Error","fetch failed");return}let n=0,i=[],l=new Date().toDateString();for(let s of e)try{if(this.settings.includeFullTranscript){let o=await this.fetchTranscript(t,s.id);s.transcript=ct(o)}if(await this.processDocument(s,t)&&n++,this.settings.enableDailyNoteIntegration&&s.created_at&&new Date(s.created_at).toDateString()===l){let c=await this.findExistingNoteByGranolaId(s.id);if(c){let u=new Date(s.created_at),m=String(u.getHours()).padStart(2,"0"),p=String(u.getMinutes()).padStart(2,"0");i.push({title:s.title||"Untitled Granola Note",actualFilePath:c.path,time:m+":"+p})}}}catch(r){console.error("Error processing document "+s.title+":",r)}this.settings.enableDailyNoteIntegration&&i.length>0&&await this.updateDailyNote(i),this.updateStatusBar("Complete",n)}catch(t){console.error("Granola sync failed:",t),this.updateStatusBar("Error","sync failed")}}async loadCredentials(){let t=H.homedir(),e=H.userInfo().username,n=[F.resolve(t,"Users",e,"Library/Application Support/Granola/supabase.json"),F.resolve(t,this.settings.authKeyPath),F.resolve(t,"Library/Application Support/Granola/supabase.json")];for(let i of n)try{if(!V.existsSync(i))continue;let l;try{l=V.readFileSync(i,"utf8")}catch(c){console.error("Failed to read credentials file:",c);continue}let{data:s,error:r}=$(l,"Granola credentials file");if(r||!s){console.error(r);continue}let o=null;if(s.workos_tokens)if(typeof s.workos_tokens=="string"){let{data:c}=$(s.workos_tokens,"WorkOS tokens");c&&(o=c.access_token)}else typeof s.workos_tokens=="object"&&(o=s.workos_tokens.access_token);if(!o&&s.cognito_tokens)if(typeof s.cognito_tokens=="string"){let{data:c}=$(s.cognito_tokens,"Cognito tokens");c&&(o=c.access_token)}else typeof s.cognito_tokens=="object"&&(o=s.cognito_tokens.access_token);if(o)return o}catch(l){console.error("Error loading credentials:",l);continue}return console.error("No valid Granola credentials found. Please ensure Granola is installed and you are logged in."),null}async fetchGranolaDocuments(t){try{let e=[],n=0,i=!0,l=this.settings.documentSyncLimit;for(;i&&e.length<l;){let r=(await(0,M.requestUrl)({url:`${Z}/v2/get-documents`,method:"POST",headers:{Authorization:"Bearer "+t,"Content-Type":"application/json",Accept:"*/*","User-Agent":`Granola/${Q}`,"X-Client-Version":Q},body:JSON.stringify({limit:L,offset:n,include_last_viewed_panel:!0,include_panels:!0})})).json;if(!r||!r.docs)return e.length>0?e:null;let o=r.docs;e.push(...o),o.length<L||e.length>=l?i=!1:n+=L,e.length>100&&this.updateStatusBar("Syncing",`${e.length} docs fetched`)}return e.length>l&&(e.length=l),e}catch(e){return console.error("Error fetching documents:",e),null}}async fetchTranscript(t,e){try{return(await(0,M.requestUrl)({url:`${Z}/v1/get-document-transcript`,method:"POST",headers:{Authorization:"Bearer "+t,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({document_id:e})})).json}catch(n){return console.error("Error fetching transcript for document "+e+":",n),null}}extractPanelContent(t,e){if(t.panels&&Array.isArray(t.panels)){for(let n of t.panels)if(n.type===e&&n.content&&n.content.type==="doc")return n.content}return e==="my_notes"&&t.notes&&t.notes.type==="doc"?t.notes:e==="enhanced_notes"&&t.last_viewed_panel&&t.last_viewed_panel.content&&t.last_viewed_panel.content.type==="doc"?t.last_viewed_panel.content:null}buildResponseStatusMap(t){var n;let e=new Map;if((n=t.google_calendar_event)!=null&&n.attendees)for(let i of t.google_calendar_event.attendees)i.email&&i.responseStatus&&e.set(i.email.toLowerCase(),i.responseStatus);return e}shouldIncludeAttendee(t){let e=this.settings.attendeeFilter;if(e==="all"||!t)return!0;switch(e){case"accepted":return t==="accepted";case"accepted_tentative":return t==="accepted"||t==="tentative";case"exclude_declined":return t!=="declined";default:return!0}}extractCompanyNames(t){var i,l,s,r,o,c,u;let e=new Set,n=this.buildResponseStatusMap(t);try{let m=t.people;if(m&&"attendees"in m&&Array.isArray(m.attendees))for(let p of m.attendees){let g=(l=(i=p.email)==null?void 0:i.toLowerCase())!=null?l:null,f=g&&(s=n.get(g))!=null?s:null;if(this.shouldIncludeAttendee(f)&&(o=(r=p.details)==null?void 0:r.company)!=null&&o.name){let w=p.details.company.name.trim();w&&e.add(w)}}if(m&&"creator"in m&&m.creator){let p=m.creator;if((u=(c=p.details)==null?void 0:c.company)!=null&&u.name){let g=p.details.company.name.trim();g&&e.add(g)}}}catch(m){console.error("Error extracting company names:",m)}return Array.from(e)}detectMeetingPlatform(t){var e;if(!this.settings.enableLocationDetection)return"";try{let n=t.google_calendar_event;if(!n)return"";let i=(n.location||"").toLowerCase(),l=[];(e=n.conferenceData)!=null&&e.entryPoints&&(l=n.conferenceData.entryPoints.filter(r=>r.uri).map(r=>r.uri.toLowerCase()));let s=[i,...l].join(" ");return s.includes("zoom.us")||s.includes("zoom.com")?"[[Zoom]]":s.includes("meet.google.com")||s.includes("hangouts.google.com")?"[[Google Meet]]":s.includes("teams.microsoft.com")||s.includes("teams.live.com")?"[[Teams]]":""}catch(n){return console.error("Error detecting meeting platform:",n),""}}getMyNameFromDocument(t){var e,n,i,l,s,r,o,c,u,m;try{if((e=t.google_calendar_event)!=null&&e.attendees){for(let p of t.google_calendar_event.attendees)if(p.self===!0){let g=(n=p.email)==null?void 0:n.toLowerCase(),f=t.people;if(f&&"creator"in f&&f.creator&&((i=f.creator.email)==null?void 0:i.toLowerCase())===g){if((r=(s=(l=f.creator.details)==null?void 0:l.person)==null?void 0:s.name)!=null&&r.fullName)return f.creator.details.person.name.fullName;if(f.creator.name)return f.creator.name}if(f&&"attendees"in f&&Array.isArray(f.attendees)){for(let w of f.attendees)if(((o=w.email)==null?void 0:o.toLowerCase())===g&&(m=(u=(c=w.details)==null?void 0:c.person)==null?void 0:u.name)!=null&&m.fullName)return w.details.person.name.fullName}if(p.displayName)return p.displayName;if(g)return j(g)}}return null}catch(p){return console.error("Error auto-detecting user name:",p),null}}getEffectiveMyName(t){if(this.settings.myName&&this.settings.myName.trim())return this.settings.myName.trim();if(this.settings.autoDetectMyName){let e=this.getMyNameFromDocument(t);if(e)return e}return""}extractAttendeeNames(t){var l,s,r,o,c,u,m,p,g,f,w,N;let e=[],n=new Set,i=this.buildResponseStatusMap(t);try{let S=t.people;if(Array.isArray(S))for(let h of S){let D=(s=(l=h.email)==null?void 0:l.toLowerCase())!=null?s:null,x=D&&(r=i.get(D))!=null?r:null;if(!this.shouldIncludeAttendee(x)){D&&n.add(D);continue}let _=null;if((c=(o=h.details)==null?void 0:o.person)!=null&&c.name){let v=h.details.person.name;v.fullName?_=v.fullName:v.givenName&&v.familyName?_=`${v.givenName} ${v.familyName}`:v.givenName&&(_=v.givenName)}else h.display_name?_=h.display_name:h.name&&(_=h.name);_&&!e.includes(_)&&(e.push(_),D&&n.add(D))}if((u=t.google_calendar_event)!=null&&u.attendees){for(let h of t.google_calendar_event.attendees)if(!(h.email&&n.has(h.email.toLowerCase()))){if(!this.shouldIncludeAttendee((m=h.responseStatus)!=null?m:null)){h.email&&n.add(h.email.toLowerCase());continue}h.displayName&&!e.includes(h.displayName)&&(e.push(h.displayName),h.email&&n.add(h.email.toLowerCase()))}}if(Array.isArray(S)){for(let h of S)if(h.email&&!n.has(h.email.toLowerCase())){let D=(p=i.get(h.email.toLowerCase()))!=null?p:null;if(!this.shouldIncludeAttendee(D)){n.add(h.email.toLowerCase());continue}if(!(h.name||h.display_name||((f=(g=h.details)==null?void 0:g.person)==null?void 0:f.name))){let _=j(h.email);e.includes(_)||(e.push(_),n.add(h.email.toLowerCase()))}}}if((w=t.google_calendar_event)!=null&&w.attendees){for(let h of t.google_calendar_event.attendees)if(h.email&&!n.has(h.email.toLowerCase())){if(!this.shouldIncludeAttendee((N=h.responseStatus)!=null?N:null)){n.add(h.email.toLowerCase());continue}if(!h.displayName){let D=j(h.email);e.includes(D)||(e.push(D),n.add(h.email.toLowerCase()))}}}return e}catch(S){return console.error("Error extracting attendee names:",S),[]}}extractAttendeeEmails(t){var l,s,r;let e=[],n=new Set,i=this.buildResponseStatusMap(t);try{let o=t.people;if(Array.isArray(o)){for(let c of o)if(c.email&&!n.has(c.email)){let u=(l=i.get(c.email.toLowerCase()))!=null?l:null;if(!this.shouldIncludeAttendee(u)){n.add(c.email);continue}e.push(c.email),n.add(c.email)}}if((s=t.google_calendar_event)!=null&&s.attendees){for(let c of t.google_calendar_event.attendees)if(c.email&&!n.has(c.email)){if(!this.shouldIncludeAttendee((r=c.responseStatus)!=null?r:null)){n.add(c.email);continue}e.push(c.email),n.add(c.email)}}}catch(o){console.error("Error extracting attendee emails:",o)}return e}generatePeopleLinks(t,e){if(!t||t.length===0)return[];let n=[],i=this.getEffectiveMyName(e);for(let l of t){if(l=ut(l),this.settings.excludeMyNameFromPeople&&i){let r=i.toLowerCase().trim(),o=l.toLowerCase().trim();if(o===r||o.includes(r)||r.includes(o))continue;let c=r.split(/[\s\-_]+/).filter(p=>p.length>1),u=o.split(/[\s\-_]+/).filter(p=>p.length>1),m=c.filter(p=>u.some(g=>g.includes(p)||p.includes(g)));if(m.length>=Math.min(c.length,u.length)&&m.length>=2)continue}let s=`[[${l}]]`;n.includes(s)||n.push(s)}return n}getAttachmentFolder(t){let e=this.app.vault.getConfig("attachmentFolderPath")||"";if(!e||e==="/")return"";if(e==="./")return t;if(e.startsWith("./")){let n=e.slice(2);return t?F.join(t,n):n}else return e}async downloadAttachments(t,e,n){var r,o;if(!this.settings.downloadAttachments)return[];let i=t.attachments;if(!i||!Array.isArray(i)||i.length===0)return[];let l=[],s=this.getAttachmentFolder(n);try{s&&(this.app.vault.getFolderByPath(s)||await this.app.vault.createFolder(s));for(let c=0;c<i.length;c++){let u=i[c];try{let m=u.url||u.file_url||u.download_url;if(!m){console.warn("Attachment has no URL:",u);continue}let p=m.includes("cloudfront.net")||m.includes("cdn."),g={url:m,method:"GET"};p||(g.headers={Authorization:"Bearer "+e});let f=await(0,M.requestUrl)(g);if(f.arrayBuffer){let w=((r=f.headers)==null?void 0:r["content-type"])||((o=f.headers)==null?void 0:o["Content-Type"]),N=gt(u,w),S=u.filename||u.name;S||(S=`attachment_${c+1}`),S=S.replace(/\.\w{3,4}$/,"");let h=t.created_at?C(t.created_at,"YYYY-MM-DD_HH-mm"):"",D=h?`${h}_${S}.${N}`:`${S}.${N}`,x=s?F.join(s,D):D;this.app.vault.getAbstractFileByPath(x)||await this.app.vault.createBinary(x,f.arrayBuffer),l.push(D)}else console.warn("No data received for attachment:",m)}catch(m){console.error("Error downloading attachment:",u.url,m)}}}catch(c){console.error("Error processing attachments:",c)}return l}generateFilename(t){let e=t.title||"Untitled Granola Note",n=t.id||"unknown_id",i="",l="",s="",r="",o="",c="";t.created_at&&(i=C(t.created_at,this.settings.dateFormat),s=C(t.created_at,"HH-mm-ss"),o=C(t.created_at,this.settings.dateFormat+"_HH-mm-ss")),t.updated_at&&(l=C(t.updated_at,this.settings.dateFormat),r=C(t.updated_at,"HH-mm-ss"),c=C(t.updated_at,this.settings.dateFormat+"_HH-mm-ss"));let u=this.settings.filenameTemplate.replace(/{title}/g,e).replace(/{id}/g,n).replace(/{created_date}/g,i).replace(/{updated_date}/g,l).replace(/{created_time}/g,s).replace(/{updated_time}/g,r).replace(/{created_datetime}/g,o).replace(/{updated_datetime}/g,c);this.settings.slashReplacement?u=u.replace(/\s*\/\s*/g,` ${this.settings.slashReplacement} `):u=u.replace(/\s*\/\s*/g," ");let m=/[:\\|?*"]/g;return u=u.replace(m,""),u=u.replace(/\s+/g,this.settings.filenameSeparator),u}buildNoteContent(t,e,n=[]){let i=[],l=t.title||"Untitled Granola Note";i.push("# "+l);let s=this.extractPanelContent(t,"my_notes");if(s&&this.settings.includeMyNotes){let o=P(s);o&&o.trim()&&i.push(`
## My Notes

`+o.trim())}let r=this.extractPanelContent(t,"enhanced_notes");if(r&&this.settings.includeEnhancedNotes){let o=P(r);o&&o.trim()&&(s&&this.settings.includeMyNotes?i.push(`
## Enhanced Notes

`+o.trim()):i.push(`
`+o.trim()))}if(this.settings.includeFullTranscript&&e&&e!=="no_transcript"&&i.push(`
## Transcript

`+e),n.length>0){let o=n.map(c=>{var m;let u=((m=c.split(".").pop())==null?void 0:m.toLowerCase())||"";return ot.includes(u)?"![["+c+"]]":"[["+c+"]]"});i.push(`
## Attachments

`+o.join(`
`))}return i.join(`
`)}buildFrontmatter(t,e=[]){var f,w;let n=t.title||"Untitled Granola Note",i=t.id||"unknown_id",l=this.extractAttendeeNames(t),s=this.generatePeopleLinks(l,t),r=this.extractAttendeeEmails(t),o=this.extractCompanyNames(t),c=this.detectMeetingPlatform(t),u=t.google_calendar_event,m=(f=u==null?void 0:u.start)==null?void 0:f.dateTime,p=(w=u==null?void 0:u.end)==null?void 0:w.dateTime,g=`---
`;if(this.settings.enableCustomFrontmatter){if(this.settings.customCategory&&(g+=`category:
  - `+E(this.settings.customCategory)+`
`),g+=`type:
`,m?g+="date: "+A(m)+`
`:t.created_at?g+="date: "+A(t.created_at)+`
`:g+=`date:
`,p?g+="dateEnd: "+A(p)+`
`:g+=`dateEnd:
`,t.created_at?g+="noteStarted: "+A(t.created_at)+`
`:g+=`noteStarted:
`,t.updated_at?g+="noteEnded: "+A(t.updated_at)+`
`:g+=`noteEnded:
`,g+=`org:
`,o.length>0)for(let N of o)g+="  - "+E("[["+N+"]]")+`
`;if(c?g+=`loc:
  - `+E(c)+`
`:g+=`loc:
`,g+=`people:
`,s.length>0)for(let N of s)g+="  - "+E(N)+`
`;if(g+=`topics:
`,this.settings.customTags){g+=`tags:
`;let N=this.settings.customTags.split(",").map(S=>S.trim()).filter(S=>S);for(let S of N)g+="  - "+E(S)+`
`}}else if(m?g+="date: "+A(m)+`
`:t.created_at&&(g+="date: "+A(t.created_at)+`
`),p&&(g+="dateEnd: "+A(p)+`
`),g+=`people:
`,s.length>0)for(let N of s)g+="  - "+E(N)+`
`;if(this.settings.includeEmails&&r.length>0){g+=`emails:
`;for(let N of r)g+="  - "+E(N)+`
`}return g+="granola_id: "+E(i)+`
`,g+="title: "+E(n)+`
`,this.settings.includeGranolaUrl&&(g+="granola_url: https://notes.granola.ai/d/"+i+`
`),g+=`---
`,g}async findExistingNoteByGranolaId(t){var i;let e=this.app.vault.getFolderByPath(this.settings.syncDirectory);if(!e)return null;let n=e.children.filter(l=>l instanceof M.TFile&&l.extension==="md");for(let l of n)try{let s=this.app.metadataCache.getFileCache(l);if((i=s==null?void 0:s.frontmatter)!=null&&i.granola_id&&String(s.frontmatter.granola_id).trim()===t)return l}catch(s){console.error("Error checking file for Granola ID:",l.path,s)}return null}async processDocument(t,e){var n,i;try{let l=t.title||"Untitled Granola Note",s=t.id||"unknown_id",r=t.transcript||"no_transcript",o=this.extractPanelContent(t,"my_notes"),c=this.extractPanelContent(t,"enhanced_notes"),u=o?P(o).trim():"",m=c?P(c).trim():"",p=!!u&&this.settings.includeMyNotes,g=!!m&&this.settings.includeEnhancedNotes,f=this.settings.includeFullTranscript&&r&&r!=="no_transcript",w=this.settings.downloadAttachments&&t.attachments&&t.attachments.length>0;if(!p&&!g&&!f&&!w)return!1;let N=await this.downloadAttachments(t,e,this.settings.syncDirectory),S=await this.findExistingNoteByGranolaId(s);if(S){if(this.settings.skipExistingNotes){let k=this.app.metadataCache.getFileCache(S),st=(n=k==null?void 0:k.frontmatter)==null?void 0:n.noteEnded,W=A(t.updated_at);if(st&&W&&W>st){let at=this.buildNoteContent(t,r,N);await this.app.vault.process(S,mt=>{let it=mt.match(/^---\n([\s\S]*?)\n---\n/);if(it){let X=it[1];return X=X.replace(/^noteEnded:.*$/m,"noteEnded: "+W),`---
`+X+`
---
`+at}return this.buildFrontmatter(t,N)+at})}return!0}let T=this.buildFrontmatter(t,N),J=this.buildNoteContent(t,r,N),q=T+J;return await this.app.vault.process(S,()=>q),!0}let h=this.buildFrontmatter(t,N),D=this.buildNoteContent(t,r,N),x=h+D,_=this.generateFilename(t)+".md",v=this.settings.syncDirectory,nt=F.join(v,_),R=nt,I=this.app.vault.getAbstractFileByPath(nt);if(I&&I instanceof M.TFile){try{let T=this.app.metadataCache.getFileCache(I);if((i=T==null?void 0:T.frontmatter)!=null&&i.granola_id&&String(T.frontmatter.granola_id).trim()===s)return await this.app.vault.modify(I,x),!0}catch(T){console.error("Error checking existing file:",T)}if(this.settings.existingFileAction==="skip")return!1;if(this.settings.existingFileAction==="timestamp"){let T=C(t.created_at,"HH-mm"),q=this.generateFilename(t)+"_"+T+".md";if(R=F.join(v,q),this.app.vault.getAbstractFileByPath(R))return!1}}return await this.app.vault.create(R,x),!0}catch(l){return console.error("Error processing document:",l),!1}}async ensureDirectoryExists(){try{this.app.vault.getFolderByPath(this.settings.syncDirectory)||await this.app.vault.createFolder(this.settings.syncDirectory)}catch(t){console.error("Error creating directory:",t)}}async updateDailyNote(t){try{let e=await this.getDailyNote();if(!e)return;let n=await this.app.vault.read(e),i=this.settings.dailyNoteSectionName,l=t.sort((u,m)=>u.time.localeCompare(m.time)).map(u=>"- "+u.time+" [["+u.actualFilePath+"|"+u.title+"]]").join(`
`),s=i+`
`+l,r=this.app.metadataCache.getFileCache(e),o=(r==null?void 0:r.headings)||[],c=o.find(u=>u.heading.trim()===i.replace(/^#+\s*/,"").trim());if(c){let u=n.split(`
`),m=c.position.start.line,p=u.length;for(let w of o)if(w.position.start.line>m&&w.level<=c.level){p=w.position.start.line;break}let g=u.slice(0,m).join(`
`),f=u.slice(p).join(`
`);n=g+`
`+s+`
`+f}else n+=`

`+s;await this.app.vault.process(e,()=>n)}catch(e){console.error("Error updating daily note:",e)}}async getDailyNote(){var t;try{let e=new Date,n=this.app.internalPlugins.getPluginById("daily-notes");if(n!=null&&n.enabled){let c=((t=n.instance)==null?void 0:t.options)||{},u=c.format||"YYYY-MM-DD",m=c.folder||"",p=lt(e,u),g=m?`${m}/${p}.md`:`${p}.md`,f=this.app.vault.getAbstractFileByPath(g);if(f instanceof M.TFile)return f;let N=this.app.vault.getMarkdownFiles().find(S=>S.basename===p);if(N)return N}let i=e.getFullYear(),l=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),r=[`${i}-${l}-${s}`,`${s}-${l}-${i}`,`${l}-${s}-${i}`],o=this.app.vault.getMarkdownFiles();for(let c of o)if(c.path.includes("Daily")){for(let u of r)if(c.path.includes(u))return c}return null}catch(e){return console.error("Error getting daily note:",e),null}}};
